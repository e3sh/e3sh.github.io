function GameBGmapControl(){}function DisplayControl(d,f,e){var a=new offScreen;this.buffer=a;var b=document.getElementById(d);b.width=f;b.height=e;var c=b.getContext("2d");this.cw=b.width;this.ch=b.height;c.font="16px 'Arial'";this.lighter_enable=true;this.putPattern=function(c,b,f,g,e,d){a.drawImgXYWHXYWH(c,b.x,b.y,b.w,b.h,f,g,e,d)};this.setBgPattern=function(a){bg_ptn=a};this.print=function(c,d,e,b){if(!Boolean(b))b="limegreen";a.fillText(c,d,e,b)};this.putImage=function(b,c,d){a.drawImgXY(b,c,d)};this.putImage2=function(b,e,f,d,c){a.drawImgXYWH(b,e,f,d,c)};this.putImageTransform=function(f,g,h,b,c,d,e){a.putImageTransform(f,g,h,b,c,d,e)};this.transform=function(b,c,d,e){a.Transform(b,c,d,e,0,0)};this.putFunc=function(b){a.putFunc(b)};this.clear=function(c){a.allClear(0,0,b.width,b.height);Boolean(c)&&a.fillRect(0,0,b.width,b.height,c)};this.fill=function(e,f,d,c,b){a.fillRect(e,f,d,c,b)};this.reset=function(){a.reset()};this.draw=function(){a.draw(c)};this.count=function(){return a.count()}}function GameAssetManager(){var a=[];this.imageLoad=function(d,c){var b=new Image;b.src=c;b.ready=false;b.addEventListener("load",function(){this.ready=true});a[d]=b;return b};this.image=a;var b=[];this.soundLoad=function(e,d){var c=".mp3";if((new Audio).canPlayType("audio/ogg")=="maybe")c=".ogg";var a=new Audio(d+c);a.ready=false;a.addEventListener("loadeddata",function(){this.ready=true});b[e]=a;return a};this.sound=b;this.check=function(){var e="<br>";for(var c in a){var d=a[c].src.split("/",20);e+=c+" "+a[c].name+" "+d[d.length-1]+" "+(a[c].ready?"o":"x")+"<br>"}for(var c in b){var d=b[c].src.split("/",20);e+=c+" "+b[c].name+" "+d[d.length-1]+" "+(b[c].ready?"o":"x")+"<br>"}return e}}function GameCore(c){var k=60,a=0,h=Date.now();window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(d){a++;if(a>k){a=1;h=Date.now()}var c=h+Math.round(a*(1e3/k)),e=Date.now(),b=c-e;if(b<=0)b=1;setTimeout(d,b)}}();var b=false,f=new GameTaskControl(this),e=new GameAssetManager,m=new inputKeyboard,n=new inputMouse,d=[];for(var l in c){var g=c[l];d[l]=new DisplayControl(g.canvasId,g.resolution.w,g.resolution.h)}if(c.length>0)var p=d[0];var i=new GameSpriteControl(this),j=[];this.setSpFont=function(a){var b={Image:e.image[a.id],pattern:a.pattern},c=new GameSpriteFontControl(this,b);j[a.name]=c};var e=new GameAssetManager,o=new soundControl(e);document.getElementById("console").innerHTML="START GAME CORE";function q(){if(b){f.step();f.draw();requestAnimationFrame(arguments.callee)}}this.task=f;this.asset=e;this.keyboard=m;this.mouse=n;this.dsp=p;this.screen=d;this.sound=o;this.sprite=i;this.font=j;i.useScreen(0);this.run=function(){b=true;requestAnimationFrame(q)};this.pause=function(){b=false}}function GameTaskControl(b){var a=[],d=0,c="";function e(){d=0;c="";for(var b in a){c+=b+" ";d++}}this.read=function(b){return a[b]};this.add=function(c){a[c.id]=c;c.init(b);e()};this.del=function(b){b.post();delete a[b.id];e()};this.init=function(c){a[c].init(b)};this.step=function(){for(var d in a){var c=a[d];if(!c.preFlag){c.pre(b);c.preFlag=true}c.enable&&c.step(b)}};this.draw=function(){for(var d in a){var c=a[d];c.visible&&c.draw(b)}};this.count=function(){return d};this.namelist=function(){return c}}function inputKeyboard(){var a=[];this.upkey=false;this.downkey=false;this.leftkey=false;this.rightkey=false;this.shift=false;this.ctrl=false;this.alt=false;this.space=false;this.qkey=false;this.wkey=false;this.ekey=false;this.akey=false;this.skey=false;this.dkey=false;this.zkey=false;this.xkey=false;this.ckey=false;function b(){this.upkey=false;this.downkey=false;this.leftkey=false;this.rightkey=false;this.shift=false;this.ctrl=false;this.space=false;this.qkey=false;this.wkey=false;this.ekey=false;this.akey=false;this.skey=false;this.dkey=false;this.zkey=false;this.xkey=false;this.ckey=false}window.addEventListener("blur",function(){a=[]},false);window.addEventListener("keydown",function(b){a[b.keyCode]=true},false);window.addEventListener("keyup",function(b){a[b.keyCode]=false},false);this.check=function(){b();for(var c in a)switch(c){case"16":this.shift=a[16];break;case"17":this.ctrl=a[17];break;case"18":this.alt=a[18];break;case"32":this.space=a[32];break;case"38":this.upkey=a[38];break;case"40":this.downkey=a[40];break;case"37":this.leftkey=a[37];break;case"39":this.rightkey=a[39];break;case"65":this.akey=a[65];break;case"67":this.ckey=a[67];break;case"68":this.dkey=a[68];break;case"69":this.ekey=a[69];break;case"81":this.qkey=a[81];break;case"83":this.skey=a[83];break;case"87":this.wkey=a[87];break;case"88":this.xkey=a[88];break;case"90":this.zkey=a[90]}return a};this.state=function(){return keymapt}}function inputMouse(){var a={x:0,y:0,button:0,wheel:0},e=0,f=0,b=-1,d=0,c=document;c.addEventListener("mousemove",function(a){e=a.clientX;f=a.clientY},false);c.addEventListener("mousedown",function(a){b=a.button},false);c.addEventListener("mouseup",function(){b=-1},false);c.addEventListener("mousewheel",function(a){d=a.wheelDelta},false);c.addEventListener("DOMMouseScroll",function(a){d=a.detail},false);this.check=function(){a.x=e;a.y=f;a.button=b;a.wheel=d;if(b!=0)b=-1;d=0;return a};this.check_last=function(){return a}}function offScreen(){for(var j=1500,d=0,p=[],f=0;f<j;f++)p[f]=new b;var a=[],e=0;function c(){d++;if(d>=j)d=0;return p[d]}this.spPut=function(e,p,r,o,n,l,m,k,j,f,g,h,i,s,t,d,u){var b=c();b.img=e;b.sx=p;b.sy=r;b.sw=o;b.sh=n;b.dx=l;b.dy=m;b.dw=k;b.dh=j;b.m11=f;b.m12=g;b.m21=h;b.m22=i;b.tx=s;b.ty=t;b.alpha=d;b.r=u;b.mode=q;a[a.length]=b};this.drawImgXYWHXYWH=function(d,l,m,k,j,h,i,f,e){var b=c();b.img=d;b.sx=l;b.sy=m;b.sw=k;b.sh=j;b.dx=h;b.dy=i;b.dw=f;b.dh=e;b.mode=g;a[a.length]=b};this.fillText=function(e,f,g,d){if(!Boolean(d))d="limegreen";var b=c();b.text=e;b.sx=f;b.sy=g;b.color=d;b.mode=o;a[a.length]=b};this.drawImgXY=function(d,e,f){var b=c();b.img=d;b.sx=e;b.sy=f;b.mode=k;a[a.length]=b};this.drawImgXYWH=function(d,g,h,f,e){var b=c();b.img=d;b.sx=g;b.sy=h;b.sw=f;b.sh=e;b.mode=i;a[a.length]=b};this.putImageTransform=function(i,j,k,d,e,f,g){var b=c();b.img=i;b.tx=j;b.ty=k;b.m11=d;b.m12=e;b.m21=f;b.m22=g;b.mode=h;a[a.length]=b};this.transform=function(d,e,f,g){var b=c();b.m11=d;b.m12=e;b.m21=f;b.m22=g;b.mode=l;a[a.length]=b};this.putFunc=function(b){a[a.length]=b};this.allClear=function(f,g,e,d){var b=c();b.sx=f;b.sy=g;b.sw=e;b.sh=d;b.mode=m;a[a.length]=b};this.fillRect=function(g,h,f,e,d){var b=c();b.sx=g;b.sy=h;b.sw=f;b.sh=e;b.color=d;b.mode=n;a[a.length]=b};this.reset=function(){a=[];d=0};this.draw=function(d){for(var b=0,c=a.length;b<c;b++)a[b].draw(d);if(e<a.length)e=a.length};this.count=function(){return e};var r=0,q=1,g=2,i=3,k=4,o=5,h=6,l=7,m=8,n=9;function b(){this.img;this.text;this.sx;this.sy;this.sw;this.sh;this.dx;this.dy;this.dw;this.dh;this.color;this.m11;this.m12;this.m21;this.m22;this.tx;this.ty;this.alpha;this.r;this.mode}b.prototype.func=[];b.prototype.func[r]=function(){};b.prototype.func[q]=function(a){a.save();a.setTransform(this.m11,this.m12,this.m21,this.m22,this.tx,this.ty);this.r!=0&&a.rotate(Math.PI/180*this.r);if(this.alpha==255)a.globalCompositeOperation="source-over";else a.globalAlpha=this.alpha*(1/255);a.drawImage(this.img,this.sx,this.sy,this.sw,this.sh,this.dx,this.dy,this.dw,this.dh);a.restore()};b.prototype.func[g]=function(a){a.drawImage(this.img,this.sx,this.sy,this.sw,this.sh,this.dx,this.dy,this.dw,this.dh)};b.prototype.func[i]=function(a){a.drawImage(this.img,this.sx,this.sy,this.sw,this.sh)};b.prototype.func[k]=function(a){a.drawImage(this.img,this.sx,this.sy)};b.prototype.func[o]=function(a){a.fillStyle=this.color;a.fillText(this.text,this.sx,this.sy)};b.prototype.func[h]=function(a){a.save();a.setTransform(this.m11,this.m12,this.m21,this.m22,this.tx,this.ty);a.drawImage(this.img,0,0);a.restore()};b.prototype.func[l]=function(){};b.prototype.func[m]=function(a){a.save();a.setTransform(1,0,0,1,0,0);a.clearRect(this.sx,this.sy,this.sw,this.sh);a.restore()};b.prototype.func[n]=function(a){if(Boolean(this.color)){a.fillStyle=this.color;a.fillRect(this.sx,this.sy,this.sw,this.sh)}else a.clearRect(this.sx,this.sy,this.sw,this.sh)};b.prototype.draw=function(a){this.func[this.mode].call(this,a)}}function offScreenTypeB(d,c){var b=document.createElement("canvas");b.width=d;b.height=c;var a=b.getContext("2d");this.flip=function(c){c.putImageData(a.getImageData(0,0,b.width,b.height),0,0)};this.spPut=function(d,o,p,n,m,k,l,j,i,e,f,g,h,q,r,b,c){a.save();a.setTransform(e,f,g,h,q,r);c!=0&&a.rotate(Math.PI/180*c);if(b==255)a.globalCompositeOperation="source-over";else a.globalAlpha=b*(1/255);a.drawImage(d,o,p,n,m,k,l,j,i);a.restore()};this.drawImgXYWHXYWH=function(b,i,j,h,g,e,f,d,c){a.drawImage(b,i,j,h,g,e,f,d,c)};this.fillText=function(c,d,e,b){if(!Boolean(b))b="limegreen";a.fillStyle=b;a.fillText(c,d,e)};this.drawImgXY=function(b,c,d){a.drawImage(b,c,d)};this.drawImgXYWH=function(b,e,f,d,c){a.drawImage(b,e,f,d,c)};this.putImageTransform=function(b,g,h,c,d,e,f){a.save();a.setTransform(c,d,e,f,g,h);a.drawImage(b,0,0);a.restore()};this.transform=function(){};this.putFunc=function(b){b.draw(a)};this.allClear=function(d,e,c,b){a.save();a.setTransform(1,0,0,1,0,0);a.clearRect(d,e,c,b);a.restore()};this.fillRect=function(e,f,d,c,b){if(Boolean(b)){a.fillStyle=b;a.fillRect(e,f,d,c)}else a.clearRect(e,f,d,c)};this.reset=function(){};this.draw=function(a){this.flip(a)};this.count=function(){return 0}}function soundControl(b){var a=b.sound;this.play=function(c){var b=a[c];if(b.ended)b.currentTime=0;b.play()};this.effect=function(c){var b=a[c];b.currentTime=0;b.play()};this.running=function(b){return!a[b].ended};this.info=function(c){var b=a[c];return b.currentTime/b.duration*100};this.restart=function(b){a[b].currentTime=0};this.volume=function(c,b){a[c].volume=b}}function GameSpriteControl(g){var a=[],b=[],c,d=true;function e(){this.x=0;this.y=0;this.r=0;this.z=0;this.priority=0;this.collisionEnable=true;this.collision={w:0,h:0};this.id;this.count=0;this.pcnt=0;this.visible=false;this.hit=[];this.alive=0;this.vx=0;this.vy=0}this.set=function(b,d,c,g,f){if(!Boolean(a[b]))a[b]=new e;a[b].id=d;a[b].count=0;a[b].pcnt=0;if(Boolean(c)){a[b].collisionEnable=true;a[b].collision={w:g,h:f}}else a[b].collisionEnable=false;a[b].visible=false};this.setMove=function(f,g,d,e){var b=a[f],c=(g-90)*(Math.PI/180);b.vx=Math.cos(c)*d;b.vy=Math.sin(c)*d;b.alive=e};this.pos=function(c,e,f,d,g){var b=a[c];b.x=e;b.y=f;b.r=d;b.z=g;b.visible=true;a[c]=b};this.reset=function(c){var b=a[c];b.visible=false;b.collisionEnable=false;b.alive=0;b.vx=0;b.vy=0};this.manualDraw=function(a){if(a)d=false;else d=true};this.useScreen=function(a){c=g.screen[a].buffer};this.put=function(h,e,g,i,j){var d=a[h];d.x=e;d.y=g;d.r=i;d.z=j;if(!Boolean(b[d.id]))c.fillText(h+" "+d.count,e,g);else{f(b[d.id].image,b[d.id].pattern[d.pcnt],e,g,i,j);d.count++;if(d.count>b[d.id].wait){d.count=0;d.pcnt++}if(d.pcnt>b[d.id].pattern.length-1)d.pcnt=0}};this.get=function(b){if(Boolean(b)){if(!Boolean(a[b]))a[b]=new e;return a[b]}else{var c=-1;for(var d in a)if(!a[d].visible)c=d;if(c==-1)c=a.length;return c}};this.setPattern=function(c,a){b[c]={image:g.asset.image[a.image],wait:a.wait,pattern:a.pattern}};this.check=function(d){var c=[];for(var b in a){var h=a[b];if(h.visible)h.collisionEnable&&c.push(b)}for(var g=[],f={x:a[d].x,y:a[d].y,w:a[d].collision.w/2,h:a[d].collision.h/2},b=0,i=c.length;b<i;b++)if(d!=c[b]){var e={x:a[c[b]].x,y:a[c[b]].y,w:a[c[b]].collision.w/2,h:a[c[b]].collision.h/2};Math.abs(f.x-e.x)<f.w+e.w&&Math.abs(f.y-e.y)<f.h+e.h&&g.push(c[b])}return g};function f(f,a,g,h,e,b,d){if(!Boolean(e))e=a.r;if(!Boolean(d))d=255;if(!Boolean(b))b=1;var i=!a.fv&&!a.fh&&e==0&&d==255;if(i)c.drawImgXYWHXYWH(f,a.x,a.y,a.w,a.h,g+-a.w/2*b,h+-a.h/2*b,a.w*b,a.h*b);else{var k=a.fv?-1:1,j=a.fh?-1:1;c.spPut(f,a.x,a.y,a.w,a.h,-a.w/2*b,-a.h/2*b,a.w*b,a.h*b,j,0,0,k,g,h,d,e)}}this.allDrawSprite=function(){if(d)for(var g in a){var e=a[g];if(e.alive>0){e.alive--;e.x+=e.vx;e.y+=e.vy;if(e.alive<=0)e.visible=false}if(e.visible)if(!Boolean(b[e.id]))c.fillText(g+" "+e.count,e.x,e.y);else{f(b[e.id].image,b[e.id].pattern[e.pcnt],e.x,e.y,e.r,e.z);e.count++;if(e.count>b[e.id].wait){e.count=0;e.pcnt++}if(e.pcnt>b[e.id].pattern.length-1)e.pcnt=0}}}}function GameSpriteFontControl(c,a){var b=c.screen[0].buffer;this.useScreen=function(a){b=c.screen[a].buffer};var e=a.Image,d=a.pattern;this.putchr=function(i,m,n,c){var h=false;if(!Boolean(c))c=1;else if(c!=1)h=true;for(var f=0,l=i.length;f<l;f++){var g=i.charCodeAt(f);if(g>=32&&g<128){var a=d[g-32],j=m+f*(a.w*c),k=n;if(h){j+=-a.w/2*c;k+=-a.h/2*c}b.drawImgXYWHXYWH(e,a.x,a.y,a.w,a.h,j,k,a.w*c,a.h*c)}}}}