function character(){var d=[[0,1,10,98,16,16,32,32,0,0,24,15,15,24,0,0],[1,4,7,2,16,16,32,32,0,0,7,5,5,7,0,1],[2,7,1,3,4,4,2,2,4,4,5,5,5,5,0,0],[3,7,2,3,8,8,6,6,4,4,5,5,5,5,0,0],[4,7,4,2,8,8,6,6,14,14,7,5,5,7,0,10],[5,7,1,3,8,8,8,8,4,4,5,5,5,5,0,0],[6,26,20,1,16,16,16,16,"common_vset2",13,5,5,5,5,0,0],[7,11,1,4,16,8,32,16,4,4,22,5,5,5,0,100],[8,11,1,4,16,8,32,16,4,4,22,5,5,5,0,100],[9,11,1,4,16,8,32,16,4,4,22,5,5,5,0,100],[10,15,10,0,8,8,8,8,21,21,7,15,15,7,1,0],[11,15,10,0,8,8,8,8,21,21,7,15,15,7,1,0],[12,7,1,3,4,4,2,2,18,18,5,5,5,5,0,0],[13,14,3,1,8,8,4,4,20,20,5,5,5,5,0,0],[14,20,70,2,16,16,24,24,0,0,35,5,5,35,0,50],[15,12,70,2,16,16,24,24,0,0,35,5,5,35,0,50],[16,13,99,0,80,16,160,32,0,0,5,5,5,5,0,0],[17,13,99,5,80,16,160,32,26,26,5,5,5,5,0,0],[18,16,0,5,112,16,0,0,28,28,28,5,5,5,0,0],[19,17,0,5,16,48,0,0,29,29,29,5,5,5,0,0],[20,18,1,4,8,8,16,16,30,30,5,5,5,5,0,8],[20,26,1,4,8,8,16,16,30,30,5,5,5,5,0,8],[21,14,1,1,8,8,-99,-99,31,31,5,5,5,5,0,0],[22,8,1,3,8,8,16,16,33,33,5,5,5,5,0,0],[23,21,5,1,8,16,6,6,45,45,5,5,5,5,0,0],[24,23,5,3,8,8,6,6,49,49,5,5,5,5,0,0],[100,8,1,3,8,8,6,6,100,100,5,5,5,5,0,0],[101,8,1,3,8,8,6,6,101,101,5,5,5,5,0,0],[102,8,1,3,8,8,6,6,102,102,5,5,5,5,0,0],[103,8,1,3,8,8,6,6,103,103,5,5,5,5,0,0],[104,8,1,3,8,8,6,6,104,104,5,5,5,5,0,0],[106,8,1,3,8,8,6,6,105,105,5,5,5,5,0,0]],c=[];for(var e in d){var a=d[e],b={};b.mp=a[1];b.hp=a[2];b.type=a[3];b.center_x=a[4];b.center_y=a[5];b.size_x=a[6];b.size_y=a[7];b.senario=[a[8],a[9],a[10],a[11],a[12],a[13]];b.id=a[14];b.score=a[15];c[a[0]]=b}return c}function sce_common_vset(a){this.init=function(c,b){b.vset(a)};this.move=function(b,a){return a.sc_move()}}function sce_common_signal(a){this.init=function(b,a){a.vset(0);a.normal_draw_enable=false;a.custom_draw_enable=false;a.x=a.gt.world_x+1;a.y=a.gt.world_y+1};this.move=function(c,b){b.x=b.gt.world_x+1;b.y=b.gt.world_y+1;if(b.frame==0)b.SIGNAL(a);else{b.SIGNAL(0);b.status=0}b.frame++;return b.sc_move()}}function Dangeon_tod(){MAP_W=10;MAP_H=10;DMAP_W=MAP_W*2+2;DMAP_H=MAP_H*2+2;var b=[[]],a=[[]];this.map=a;this.mw=DMAP_W;this.mh=DMAP_H;this.create=function(){for(var d=0;d<MAP_W;d++){b[d]=[];for(var e=0;e<MAP_H;e++)b[d][e]=-1}for(var d=0;d<DMAP_W;d++){a[d]=[];for(var e=0;e<DMAP_H;e++)a[d][e]="  "}for(var i=[0,1,0,-1],j=[-1,0,1,0],d=0;d<MAP_W;d++)for(var e=0;e<MAP_H;e++){var k=Math.floor(Math.random()*4);b[d][e]==-1&&c(d,e,k)}for(var d=0;d<MAP_W;d++)for(var e=0;e<MAP_H;e++){var g=d*2+1,h=e*2+1,f=b[d][e];a[g][h]="\u25a1";a[g+i[f]][h+j[f]]=f%2?"\u2501":"\u2503"}};this.draw=function(){};function c(d,e,a){var f=[0,1,0,-1],g=[-1,0,1,0];b[d][e]=a;if(d+f[a]<0||d+f[a]>=MAP_W)return 1;if(e+g[a]<0||e+g[a]>=MAP_H)return 1;if(b[d+f[a]][e+g[a]]!=-1)return 1;d+=f[a];e+=g[a];var h=Math.floor(Math.random()*3)-1;a+=h;if(a<0)a=3;if(a>=3)a=0;return c(d,e,a)}}function deviceControl(){var b=new Screen("b_canvas"),a=new Screen("a_canvas"),c=new TextScreen("text_div"),f=new inputControl("a_canvas"),d=new inputKeyboard,e=new geometoryTrance;this.graphics=a;this.graphics1=a;this.graphics2=b;this.text=c;this.canvas=a;this.canvas1=a;this.canvas2=b;this.gs=e;this.layout=new gameLayout;this.mouse_state=f;this.key_state=d}function sce_effect_vanish(){this.init=function(b,a){a.type=5;a.status=5};this.move=function(){return-1}}function sce_effect_bomb(){this.init=function(b,a){a.vset(0);a.mp=12;a.type=5;a.status=5;a.frame=0};this.move=function(b,a){switch(a.frame){case 90:a.status=0}a.frame++;if(a.frame>=30)a.status=0;return a.sc_move()}}function sce_effect_hit(){this.init=function(b,a){a.vset(0);a.mp=11;a.type=5;a.status=5;a.frame=0;a.alpha=254};this.move=function(b,a){switch(a.frame){case 60:a.status=0}a.frame++;if(a.frame>30)a.alpha-=3;return a.sc_move()}}function sce_effect_billboard(a){this.init=function(c,b){b.vector=a;b.vset(2)};this.move=function(b,a){if(a.alpha>10)a.alpha-=5;else return-1;return a.sc_move()}}function sce_effect_bombcircle(a){this.init=function(b,a){a.vset(0);a.circle_r=20;a.type=5;a.normal_draw_enable=false;a.custom_draw_enable=true};this.move=function(b,a){if(a.frame>10)a.status=0;a.circle_r+=(a.frame+1)*10;a.frame++;return a.sc_move()};this.draw=function(e,c){var b={},d=c.gt.worldtoView(c.x,c.y);b.x=d.x;b.y=d.y;b.r=c.circle_r;b.draw=function(b){b.beginPath();b.globalCompositeOperation="lighter";b.arc(this.x,this.y,this.r,0,Math.PI*2,false);b.fillStyle=a;b.fill();b.globalCompositeOperation="source-over"};e.putFunc(b)}}function sce_effect_warnning_mark(){this.init=function(b,a){a.vset(0);a.type=5;a.mp=28};this.move=function(b,a){if(a.frame>30)a.status=0;a.frame++;return a.sc_move()}}function sce_ememy_move_n(a,b){this.init=function(b,a){a.vset(4)};this.move=function(d,c){switch(c.frame){case 80:c.get_target(98);break;case 100:c.vector=c.target_v();c.set_object(103);break;case 110:c.set_object(3);break;case 120:c.set_object(4);c.vector=a;c.vset(4);break;case 160:c.vector=b;c.vset(4)}c.frame++;c.frame++;return c.sc_move()}}function sce_ememy_turn(a){this.init=function(b,a){a.vset(4)};this.move=function(c,b){switch(b.frame){case 5:b.set_object_ex(3,b.x,b.y,b.vector+Math.floor(Math.random()*40)-20,"exev_5expansion");break;case 15:b.vector+=a;b.vset(4);break;case 25:b.vector+=a;b.vset(4);break;case 35:b.vector+=a;b.vset(4);break;case 45:b.frame=9}b.frame++;return b.sc_move()}}function sce_ememy_change_s(){this.init=function(b,a){a.vset(4);a.vector=180};this.move=function(b,a){if(a.frame==15){a.set_object(102);a.change_sce(9)}a.frame++;return a.sc_move()}}function sce_ememy_moveshot(){this.init=function(b,a){a.vset(4)};this.move=function(b,a){if(a.vector>180)a.mp=5;else a.mp=4;if(a.frame%50==5)if(a.frame>3600)a.set_object_ex(5,a.x,a.y,a.vector,"en_bullet_homing");else a.set_object_ex(5,a.x,a.y,a.vector,"en_bullet_turn");a.frame++;return a.sc_move()}}function sce_ememy_randomshot(){this.init=function(b,a){a.vset(4);a.w_cnt=0;a.display_size=1.5};this.move=function(b,a){if(a.vector>180)a.mp=5;else a.mp=4;switch(a.frame){case 10:a.vset(0);break;case 13:a.set_object(12);break;case 30:a.frame=12;a.w_cnt++}a.frame++;if(a.w_cnt>5){a.w_cnt=0;a.vset(2);a.frame=0}return a.sc_move()}}function sce_ememy_move_std(){this.init=function(b,a){a.vset(2);a.wmapc=false;a.colcnt=0};this.move=function(c,a){a.frame++;if(a.wmapc){var b=Math.floor(Math.random()*2)==0?1:3;a.wmapc=false;a.vector+=b*90;a.vector=a.vector%360;a.vset(2);a.colcnt=0}if(a.vector>180)a.mp=5;else a.mp=4;if(a.mapCollision){a.colcnt++;if(a.colcnt>10)a.wmapc=true}return a.sc_move()}}function sce_en_bullet_homing(){this.init=function(b,a){a.vset(2);a.get_target(98);a.lifecount=0;a.cancelcol=true};this.move=function(b,a){switch(a.frame){case 10:a.target_rotate_r(15);a.vset(2);break;case 15:a.frame=9}a.frame++;a.lifecount++;if(a.cancelcol)this.mapCollision=false;return a.sc_move()}}function sce_en_bullet_random(){this.init=function(c,a){var b=Math.floor(Math.random()*50)-25;a.vector=(a.vector+b+360)%360;a.vset(4)};this.move=function(b,a){return a.sc_move()}}function sce_en_bullet_accel(){this.init=function(b,a){a.vset(4)};this.move=function(b,a){switch(a.frame){case 15:a.vx/=2;a.vy/=2;break;case 23:a.vx/=2;a.vy/=2;break;case 30:a.vx/=2;a.vy/=2;break;case 90:a.vset(6)}a.frame++;return a.sc_move()}}function sce_en_bullet_hominglaser(){this.init=function(b,a){a.vset(2);a.get_target(98);a.display_size=2;a.alpha=128;a.w_cnt=0};this.move=function(b,a){switch(a.w_cnt){case 26:a.frame>90&&a.get_target(2);a.target_rotate_r(15+(a.frame<20?15:0));a.vset(2+(a.frame>40?4:0)+(a.frame>50?4:0));break;case 30:a.w_cnt=25}a.set_object_ex(24,a.x,a.y,a.vector,56);a.w_cnt++;a.frame++;return a.sc_move()}}function sce_en_bullet_infolaser(){this.init=function(b,a){a.vset(0);a.msf=false;a.display_size=2;a.alpha=64};this.move=function(c,a){switch(a.frame){case 1:a.normal_draw_enable=false;a.custom_draw_enable=true;break;case 45:a.normal_draw_enable=true;a.custom_draw_enable=false;a.msf=true}if(a.msf)for(var b=1;b<=5;b++){a.vset(12*b);a.set_object_ex(24,a.x+a.vx,a.y+a.vy,a.vector,56)}a.frame++;return a.sc_move()};this.draw=function(d,b){var a={},c=b.gt.worldtoView(b.x,b.y);a.x=c.x;a.y=c.y;b.vset(800);a.tx=c.x+b.vx;a.ty=c.y+b.vy;b.vset(0);a.alpha=b.frame/30;a.alpha=a.alpha>1?1:a.alpha;a.draw=function(b){b.beginPath();b.moveTo(this.x,this.y);b.lineTo(this.tx,this.ty);b.lineWidth="1";b.strokeStyle="rgba( 255, 0, 0,"+a.alpha+")";b.stroke()};d.putFunc(a)}}function sce_en_bullet_turn(){this.init=function(b,a){a.vset(0);a.get_target(98)};this.move=function(b,a){if(a.frame==60){a.vector=a.target_v();a.vset(8)}a.frame++;return a.sc_move()}}function sce_en_bullet_laser_tail(){this.init=function(b,a){a.vset(0);a.display_size=2};this.move=function(b,a){if(a.frame>10)a.status=0;a.frame++;return a.sc_move()}}function gameScene(b){var e=b.graphics1,d=b.graphics2;this.init=v;this.reset=t;this.step=x;this.draw=u;this.score=0;this.result;this.config;var a,c,r,y=0,h=0,s=[],n=[],o=[],z=false,j=true,m=0,g=0,k=0,f=false,l=0,q=0,p=0;this.score_load=function(){if(Boolean(localStorage)){var a=false;if(Boolean(localStorage.getItem("highscore"))){a=true;this.result.highscore=parseInt(localStorage.getItem("highscore"))}}};function v(){a=new gObjectControl(e,b);c=new mapSceControl;c.init();this.result={};this.result.highscore=0;this.result.score=0;this.result.item=a.item;this.result.combo=a.combo;f=false}function t(b){a.config=this.config;if(!Boolean(b))b=false;f=false;if(b){a.reset(true);if(this.config.cold)h=-1}else{a.reset(false);c.change(this.config.startstage);c.init();c.reset();h=0;this.result.nowstage=1;j=true;m=0;g=0;k=0}p=0;if((b=true)&&!this.config.cold){w=c.stage;w++;c.change(w);c.stage=w;this.result.nowstage=w;var e=a.score;a.reset(false);a.score=e;c.reset();g=0;k=0}s=c.bgImage();n=c.mapChip();o=c.bgPtn();d.clear("darkgreen");d.reset();r=new gs_score_effect(a.score);ehighscore=new gs_score_effect(this.result.highscore)}function x(){if(a.interrapt){if(a.SIGNAL==1){c.enable=false;c.counter_runnning=false}if(a.SIGNAL==6055){if(g==0)j=false;c.enable=true;c.counter_runnning=false}if(a.SIGNAL==835){a.score+=Math.floor((7200-c.flame)/6);this.result.score=a.score;this.result.item=a.item;this.result.combo=a.combo;this.result.combomax=a.combomax;this.result.obCount=a.obCount;this.result.total=a.total;this.result.hidan=a.hidan;this.config.cold=false;a.interrapt=false;a.SIGNAL=0;a.draw(d);f=true;return 5}if(a.SIGNAL==4649){h++;if(h<3){if(this.config.itemreset)a.item=[];a.combo=[];a.restart()}else{this.result.score=a.score;this.result.item=a.item;this.result.combo=a.combo;this.result.combomax=a.combomax;this.result.obCount=a.obCount;this.result.total=a.total;this.result.hidan=a.hidan;a.draw(d);f=true;Boolean(localStorage)&&localStorage.setItem("highscore",new String(this.result.highscore));return 3}}}else{j=true;c.enable=true;c.counter_runnning=true}var m=0,e=1;for(i in a.combo){if(i==2)m=a.combo[i];if(i==4)e=a.combo[i]}if(l!=m){l=m;if(l>=2)p=60}if(q!=e)q=e;if(!a.interrapt){a.move(c);c.step(a)}else if(a.SIGNAL!=1){a.move(c);c.step(a)}else var n=b.mouse_state.check_last();if(j)g++;if(g>480){g=0;k=1-k}if(this.result.highscore<a.score)this.result.highscore=a.score;return 0}function u(){f=true;if(m!=b.gs.world_x||g!=b.gs.world_y){f=false;m=b.gs.world_x;g=b.gs.world_y}f=false;if(!f){for(var i in n){var j=n[i];if(b.gs.in_stage_range(j.x,j.y,j.w,j.h)){j.view=true;var p=b.gs.worldtoView(j.x,j.y);if(j.visible)if(Boolean(o[j.no]))d.putPattern(s,o[j.no],p.x,p.y,j.w,j.h);else{var k={};k.x=p.x;k.y=p.y;k.w=j.w;k.h=j.h;k.draw=function(a){a.beginPath();a.strokeStyle="green";a.lineWidth=1;a.rect(this.x,this.y,this.w,this.h);a.stroke()};d.putFunc(k)}}else j.view=false}var k={};k.draw=function(a){a.beginPath();a.fillStyle="rgba(0,0,0,0.5)";a.fillRect(0,480-36,640,36)};d.putFunc(k);d.clear("black");d.draw();d.reset()}a.draw();var l=[];wt=ehighscore.read(this.result.highscore);e.putchr("Hi-Sc:"+wt,b.layout.hiscore_x,b.layout.hiscore_y);wt=r.read(a.score);e.putchr("Score:"+wt,b.layout.score_x,b.layout.score_y);if(this.config.debug){l.push("o:"+a.cnt()+"/"+a.num()+"/"+a.nonmove);l.push("f:"+c.flame);if(a.interrapt)l.push("interrapt:"+a.SIGNAL);else l.push("running:"+a.SIGNAL)}for(var i=0;i<2-h;i++)e.put("Ship",b.layout.zanki_x+i*32,b.layout.zanki_y);if(Boolean(a.item[20]))var q=a.item[20];if(q>=18)q=18;for(var i=0;i<q;i++)e.put("Ball1",b.layout.zanki_x+i*20+100,b.layout.zanki_y);e.putchr("Floor "+c.stage,b.layout.stage_x,b.layout.stage_y);e.putchr("Time:"+Math.floor((7200-c.flame)/6),b.layout.time_x,b.layout.time_y);if(this.config.debug){for(i in a.item)l.push("item["+i+"]:"+a.item[i]);for(i in a.combo)l.push("combo["+i+"]:"+a.combo[i]);for(i in a.combomax)l.push("combomax["+i+"]:"+a.combomax[i]);var t=0;for(i in a.total)if(i==2)t=a.total[i];var u=1;for(i in a.obCount)if(i==2)u=a.obCount[i];l.push("rate:"+Math.floor(t/u*100)+"par");l.push("hidan:"+a.hidan);l.push("wx,wy:"+Math.floor(b.gs.world_x)+","+Math.floor(b.gs.world_y));var k={};k.x=0;k.y=0;k.w=b.gs.viewwidth;k.h=b.gs.viewheight;k.draw=function(a){a.beginPath();a.strokeStyle="red";a.lineWidth=1;a.rect(150,150,130,180);a.stroke();a.beginPath();a.strokeStyle="red";a.lineWidth=1;a.rect(0,0,420,480);a.stroke();a.strokeStyle="red";a.lineWidth=1;a.rect(0,0,this.w,this.h);a.stroke()};e.putFunc(k)}for(var v in l)e.putchr8(l[v],b.layout.status_x,b.layout.status_y+8*v)}}function gs_score_effect(b){var a=b;this.read=function(d){if(d<=a)a=d;else if(d-a>100){c=1;ws_work=a;ts_work=d;for(var b=0;b<7;b++){if(ws_work<ts_work)a+=c;c*=10;ws_work=Math.floor(ws_work/10);ts_work=Math.floor(ts_work/10)}}else a++;var e=a,f=[],g="";for(b=0;b<7;b++){var c=e%10;f[7-b]=c;e=(e-c)/10}for(b in f)g=g+""+f[b];return g}}function geometoryTrance(){this.worldwidth=864;this.worldheight=900;this.stagewidth=740;this.stageheight=580;this.viewwidth=640;this.viewheight=480;this.world_x=0;this.world_y=0;var h=this.worldwidth,g=this.worldheight,d=this.stagewidth,c=this.stageheight,b=this.viewwidth,a=this.viewheight,e=this.world_x,f=this.world_y;this.viewtoWorld=function(b,c){var a={};a.x=this.world_x+b;a.y=this.world_y+c;return a};this.worldtoView=function(b,c){var a={};a.x=b-this.world_x;a.y=c-this.world_y;return a};this.viewpos=function(c,d){if(c<0)c=0;if(d<0)d=0;if(c>h-b)c=h-b;if(d>g-a)d=g-a;e=c;f=d};this.commit=function(){this.world_x=e;this.world_y=f};this.nowstagepos=function(){var e={};e.ltx=this.world_x+b/2-d/2;e.lty=this.world_y+a/2-c/2;e.rtx=this.world_x+b/2+d/2;e.rty=this.world_y+a/2-c/2;e.lbx=this.world_x+b/2-d/2;e.lby=this.world_y+a/2+c/2;e.rbx=this.world_x+b/2+d/2;e.rby=this.world_y+a/2+c/2;e.x=e.ltx;e.y=e.lty;e.w=d;e.h=c;return e};this.in_stage=function(f,g){var e=false;if(this.world_x+b/2-d/2<=f&&this.world_x+b/2+d/2>=f&&this.world_y+a/2-c/2<=g&&this.world_y+a/2+c/2>=g)e=true;return e};this.in_view=function(d,e){var c=false;if(this.world_x<=d&&this.world_x+b>=d&&this.world_y<=e&&this.world_y+a>=e)c=true;return c};this.in_view_range=function(f,g,e,d){var c=false;if(Math.abs(this.world_x+b/2-(f+e/2))<(b+e)/2&&Math.abs(this.world_y+a/2-(g+d/2))<(a+d)/2)c=true;return c};this.in_stage_range=function(f,g,e,b){var a=false;if(Math.abs(this.world_x+d/2-(f+e/2))<(d+e)/2&&Math.abs(this.world_y+c/2-(g+b/2))<(c+b)/2)a=true;return a}}function gObjectClass(){this.x;this.y;this.vx;this.vy;this.mp;this.vector;this.visible=false;this.center_x;this.center_y;this.hit_x;this.hit_y;this.mp_cnt_frm=0;this.mp_cnt_anm=0;this.type;this.chr;this.frame=0;this.scenario=[];this.status=0;this.hp;this.target=-1;this.crash=-1;this.id;this.score=0;this.triger=0;this.shot=0;this.alpha=255;this.display_size=1;this.message=[];this.normal_draw_enable=true;this.custom_draw_enable=false;this.damegeflag=false;this.mapCollision=false;this.mapColX=false;this.mapColY=false;this.alive=600;this.reset=function(){status=0;type=5;visible=false;mp_cnt_frm=0;mp_cnt_anm=0;scenario=[];this.normal_draw_enable=true;this.custom_draw_enable=false;damegeflag=false};this.init=b;this.move=c;this.draw=a;this.custom_draw=null;this.vset=function(a){this.vx=Math.cos(Math.PI/180*(this.vector-90))*a;this.vy=Math.sin(Math.PI/180*(this.vector-90))*a};this.set_object=function(c,b){var a={};a.cmd="set_object";a.src=c;a.dst=b;this.message.push(a)};this.set_object_ex=function(d,g,h,f,c,e){var b={},a={};a.x=g;a.y=h;a.vector=f;a.sce=c;a.id=e;b.cmd="set_object_ex";b.src=d;b.dst=a;this.message.push(b)};this.get_target=function(c,b){var a={};a.cmd="get_target";a.src=c;a.dst=b;this.message.push(a)};this.change_sce=function(c,b){var a={};a.cmd="change_sce";a.src=c;a.dst=b;this.frame=0;this.normal_draw_enable=true;this.custom_draw_enable=false;this.message.push(a)};this.add_score=function(c,b){var a={};a.cmd="add_score";a.src=c;a.dst=b;this.message.push(a)};this.get_item=function(c,b){var a={};a.cmd="get_item";a.src=c;a.dst=b;this.message.push(a)};this.bomb=function(c,b){var a={};a.cmd="bomb";a.src=c;a.dst=b;this.message.push(a)};this.bomb2=function(c,b){var a={};a.cmd="bomb2";a.src=c;a.dst=b;this.message.push(a)};this.bomb3=function(c,b){var a={};a.cmd="bomb3";a.src=c;a.dst=b;this.message.push(a)};this.collect=function(c,b){var a={};a.cmd="collect";a.src=c;a.dst=b;this.message.push(a)};this.SIGNAL=function(c,b){var a={};a.cmd="SIGNAL";a.src=c;a.dst=b;this.message.push(a)};this.reset_combo=function(c,b){var a={};a.cmd="reset_combo";a.src=c;a.dst=b;this.message.push(a)};this.sc_move=function(){var a=0;if(this.status==2)switch(this.type){case 1:case 3:this.change_sce("effect_hit");break;case 2:this.display_size*=2;this.change_sce(7);this.add_score(this.score);break;case 4:this.change_sce(6);this.get_item(this.chr)}if(this.status==0)a=1;if(this.mapCollision!=true){this.colcount=0;this.x+=this.vx;this.y+=this.vy;this.old_x=this.x;this.old_y=this.y}else{this.colcount++;this.x=this.old_x;this.y=this.old_y;switch(this.type){case 1:case 3:a=1;break;default:if(this.mapColX){this.vx*=-1;this.vector=360-this.vector;if(this.vector<0)this.vector=180+(180+this.vector)}if(this.mapColY){this.vy*=-1;this.vector=180+this.vector;if(this.vector>360)this.vector=360+180-this.vector}if(!this.mapColX&&!this.mapColY){this.vx*=-1;this.vy*=-1;this.vector=(this.vector+180)%360}}}if(this.x<0||this.x>this.gt.ww)a=2;if(this.y<0||this.y>this.gt.wh)a=2;if(a!=0){a==2&&this.reset_combo(this.type);return-1}if(this.colcount>10){this.x=Math.floor(this.x/80)*80+32;this.y=Math.floor(this.y/80)*80+32;this.colcount=0}this.damageflag=false;return 0};this.target_r=function(e,f){var g=this.x,h=this.y,a,b=e-g,c=f-h;if(b==0)if(c>=0)a=180;else a=0;else{a=d(Math.atan(c/b));if(b>=0&&c>=0)a=90+a;if(b>=0&&c<0)a=90+a;if(b<0&&c<0)a=270+a;if(b<0&&c>=0)a=270+a}return a};this.target_v=function(){return!Boolean(this.target)?this.vector:this.target_r(this.target.x,this.target.y)};this.target_rotate_r=function(c){if(!Boolean(this.target))return;var a=this.target_r(this.target.x,this.target.y),b=a;if(b>179)b=-360+b;w=this.vector;if(w>179)w=-360+w;a=b-w;if(Math.abs(a)>100){w=(this.vector+180)%360;if(w>179)w=-360+w;a=(b-w)*-1}if(Math.abs(a)<c)c=a;if(a!=0)this.vector=this.vector+a/Math.abs(a)*c;if(this.vector<0)this.vector=360+this.vector;if(this.vector>359)this.vector=this.vector-360};this.target_d=function(a,b){var c=this.x,d=this.y;return Math.sqrt(Math.abs(a-c)*Math.abs(a-c)+Math.abs(b-d)*Math.abs(b-d))};this.Sin=function(a){return Math.sin((a-90)*(Math.PI/180))};this.Cos=function(a){return Math.cos((a-90)*(Math.PI/180))};function d(a){return a*(180/Math.PI)}function b(b,a){a.vset(5)}function a(b,a){b.print(a.mp+"",a.x,a.y)}function c(c,a){a.x+=a.vx;a.y+=a.vy;var b=0;if(a.x<0||a.x>c.cw)b=1;if(a.y<0||a.y>c.ch)b=1;return b!=0?-1:0}}function gObjectControl(h,j){delobj=0;this.score=0;this.config={};this.interrapt=false;this.SIGNAL=0;this.item=[];this.combo=[];this.obCount=[];this.combomax=[];this.total=[];this.hidan=0;this.nonmove=0;var k=0,f,l,m,c=character(),d=motionPattern(),g=scenario(),a=[],e=[];e[0]=[0,0,2,1,1,0];e[1]=[0,0,1,0,0,0];e[2]=[2,1,0,0,0,0];e[3]=[1,0,0,0,0,0];e[4]=[1,0,0,0,0,0];e[5]=[0,0,0,0,0,0];this.reset=function(b){delobj=0;k=0;if(this.config.cold){this.score=0;this.obCount=[];this.combomax=[];this.total=[];this.hidan=0;this.combo=[];this.item=[]}if(!b){this.interrapt=false;this.SIGNAL=0;a=[];this.config.cold=true}if(this.config.fullpower)this.item[7]=10};this.move=function(t){f=t;var G=j.mouse_state.check_last(),F=j.key_state.check();this.nonmove=0;for(var i in a){var c=a[i],q=c.gt.in_stage_range(c.x-c.hit_x/2,c.y-c.hit_y/2,c.hit_x,c.hit_y);if(!q){this.nonmove++;if(c.type==1||c.type==3)c.status=0;if(c.type!=5)continue}c.mouse_state=G;c.key_state=F;if(c.move(h,c,t)!=0){delete a[i];delobj++}for(var I in c.message){var g=c.message[I];if(g.cmd=="add_score")this.score+=g.src;if(g.cmd=="get_item"){if(Boolean(this.item[g.src]))this.item[g.src]++;else this.item[g.src]=1;var s=1;if(g.src==20)s=this.item[20];this.score+=c.score*s;var K=g.src==7?"Powerup!":c.score*s+"pts.";f.add(c.x,c.y,0,20,43+(g.src==7?1:0),K)}if(g.cmd=="reset_combo")for(var v in this.combo)if(g.src==v)this.combo[v]=0;if(g.cmd=="SIGNAL")if(this.interrapt){this.interrapt=false;this.SIGNAL=0}else{this.interrapt=true;this.SIGNAL=g.src;if(g.src==0)this.interrapt=false}if(g.cmd=="bomb2"||g.cmd=="bomb3")if(Boolean(this.item[7]))if(this.item[7]>0)this.item[7]--;b[g.cmd](c,g.src,g.dst)}c.message=[]}var o=f.mapChip(),B=[],u=0;for(var M in o){var d=o[M];if(d.c){B[u]=d;u++}}var p=[];for(i in a){p[i]=0;c=a[i];c.crash=null;c.attack=c.hp;var q=c.gt.in_stage_range(c.x-c.hit_x/2,c.y-c.hit_y/2,c.hit_x,c.hit_y);q=true;if(!q)continue;var C=c.type==98?0:c.type;for(var r in a){var n=a[r];if(p[r]!=0)continue;if(i==r)continue;var D=n.type==98?0:n.type,H=e[C][D];if(H==0)continue;if(Math.abs(c.x-n.x)<(c.hit_x+n.hit_x)/2&&Math.abs(c.y-n.y)<(c.hit_y+n.hit_y)/2){c.status=2;n.status=2;c.crash=n;n.crash=c;p[r]=1;p[i]=1}}c.mapCollision=false;c.mapColX=false;c.mapColY=false;for(var y in o){var d=o[y],w=false,E=c.mapCollision,z=c.mapColX,A=c.mapColY;if(d.c&&d.view){if(Math.abs(c.x+c.vx-(d.x+d.w/2))<(c.hit_x+d.w)/2&&Math.abs(c.y+c.vy-(d.y+d.h/2))<(c.hit_y+d.h)/2){c.mapCollision=true;w=true}if(Math.abs(c.x+c.vx-(d.x+d.w/2))<(c.hit_x+d.w)/2&&Math.abs(c.y-(d.y+d.h/2))<(c.hit_y+d.h)/2)c.mapColX=true;if(Math.abs(c.x-(d.x+d.w/2))<(c.hit_x+d.w)/2&&Math.abs(c.y+c.vy-(d.y+d.h/2))<(c.hit_y+d.h)/2)c.mapColY=true;if(w){if(d.type==0&&(c.type==1||c.type==1))delete o[y];if(d.type==2){if(c.type==98)c.doorflag=true;c.mapCollision=E;c.mapColX=z;c.mapColY=A}}}}}for(i in a){c=a[i];var q=c.gt.in_stage_range(c.x-c.hit_x/2,c.y-c.hit_y/2,c.hit_x,c.hit_y);q=true;if(!q)continue;if(p[i]!=0){var O=0,N=0,P=0;if(!(c.type==1||c.type==3)){var L=true;if(L){var J=c.hp;if(c.type==4)c.hp=0;if(c.crash.type!=4)c.hp-=c.crash.attack;if(c.hp>0){c.status=1;if(J!=c.hp){if(c.type==98)this.hidan++;c.damageflag=true}c.crash=null}else c.type==2&&this.combo_sub(2)}}}}var x=0;for(i in a)if(a[i].type==98)x++;if(x==0){k++;if(k>90){l=this.interrapt;m=this.SIGNAL;this.interrapt=true;this.SIGNAL=4649}}};this.combo_sub=function(a){if(!Boolean(this.combo[a]))this.combo[a]=1;else this.combo[a]++;if(!Boolean(this.combomax[a]))this.combomax[a]=this.combo[a];else if(this.combo[a]>this.combomax[a])this.combomax[a]=this.combo[a];if(!Boolean(this.total[a]))this.total[a]=1;else this.total[a]++;return this.combo[a]};this.restart=function(){f.start(false);k=0;this.interrapt=l;this.SIGNAL=m};var b=[];b.set_object=function(a,b){f.add(a.x,a.y,a.vector,b)};b.set_object_ex=function(c,b,a){f.add(a.x,a.y,a.vector,b,a.sce,a.id)};b.get_target=function(b,f){var h=1,d=99999;b.target=null;for(var g in a){var c=a[g];if(c.type!=f)continue;var e=c.target_d(b.x,b.y);if(e<d){b.target=c;d=e}}};b.change_sce=function(a,b){a.init=g.init[b];a.move=g.move[b];a.custom_draw=g.draw[b];a.init(h,a)};b.add_score=function(c,a){return a};b.get_item=function(c,a){return a};b.bomb=function(){for(i in a)a[i].type==3&&a[i].change_sce(7)};b.bomb2=function(b){for(i in a){b=a[i];if(b.type==3){b.type=4;b.mp=18;b.score=8;if(b.chr!=7){var c=[18,22,26,27,29,30];b.mp=c[Math.floor(Math.random()*c.length)]}b.change_sce(30)}}};b.bomb3=function(){for(i in a){if(a[i].type==2){a[i].hp-=10;if(a[i].hp<=0)a[i].status=2}a[i].type==3&&a[i].change_sce(7)}};b.collect=function(b){for(i in a){b=a[i];if(b.type==4)if(!Boolean(b.collection_mode)){b.collection_mode=true;b.change_sce(30)}}};b.SIGNAL=function(){};b.reset_combo=function(){};this.draw=function(c){if(!Boolean(c))c=h;for(var d in a){var b=a[d];if(b.visible){if(b.normal_draw_enable)j.gs.in_view(b.x,b.y)&&b.draw(c,b);b.custom_draw_enable&&b.custom_draw(c,b)}}};this.set_s=o;function o(m,o,l,d,e,k){var b=new gObjectClass;b.reset();b.scrn=h;b.mouse_state=j.mouse_state.check_last();b.gt=j.gs;b.item=this.item;b.config=this.config;b.x=m;b.y=o;b.vector=l;b.chr=d;b.visible=true;b.mp=c[d].mp;b.hp=c[d].hp;b.maxhp=b.hp;b.type=c[d].type;b.center_x=c[d].center_x;b.center_y=c[d].center_y;b.hit_x=c[d].size_x;b.hit_y=c[d].size_y;if(!Boolean(k))k=c[d].id;b.id=k;b.score=c[d].score;b.status=1;if(!Boolean(e))e=c[d].senario[0];b.init=g.init[e];b.move=g.move[e];b.draw=n;b.custom_draw=g.draw[e];b.init(h,b);for(var i=-1,f=0;f<a.length;f++)if(!a[f]){i=f;break}if(i==-1)a.push(b);else a[i]=b;if(Boolean(this.obCount[b.type]))this.obCount[b.type]++;else this.obCount[b.type]=1;if(b.type==1&&b.type==3)b.alive=90}this.num=function(){return a.length};this.cnt=function(){var b=0;for(var c in a)b++;return b};function n(c,a){if(Boolean(d[a.mp].wait)){a.mp_cnt_frm++;if(a.mp_cnt_frm>d[a.mp].wait/2){a.mp_cnt_anm++;a.mp_cnt_frm=0;if(a.mp_cnt_anm>=d[a.mp].pattern.length)a.mp_cnt_anm=0}}try{var g=d[a.mp].pattern[a.mp_cnt_anm][0]}catch(h){a.mp_cnt_anm=0;g=d[a.mp].pattern[a.mp_cnt_anm][0]}var e=d[a.mp].pattern[a.mp_cnt_anm][1],f=d[a.mp].pattern[a.mp_cnt_anm][2];if(e==-1&&f==-1){e=0;f=a.vector}var b=a.gt.worldtoView(a.x,a.y);b.x>=0&&b.x<=c.cw&&b.y>=0&&b.y<=c.ch&&c.put(g,b.x,b.y,e,f,a.alpha,a.display_size)}}function inputControl(){var a,b,e,f,g=0,h=0,d,l=-1,k,i=0,j="NaN",n=0,m=0,c=document;this.o_Left=c.offsetLeft;this.o_Top=c.offsetTop;c.onmousemove=t;function t(c){x=c.clientX;y=c.clientY;if(!Boolean(a))a=x;if(!Boolean(b))b=y;g=x;h=y}c.onmousedown=function(a){d=a.button};c.onmouseup=function(){d=-1};c.onmousewheel=function(a){k=a.wheelDelta};c.addEventListener("DOMMouseScroll",s,false);function s(a){k=a.detail}c.ontouchmove=function(c){c.preventDefault();if(c.touches.length>0)for(var d=0;d<c.touches.length;d++){var e=c.touches[d];x=e.pageX;y=e.pageY}if(!Boolean(a))a=x;if(!Boolean(b))b=y;g=x;h=y};c.ontouchstart=function(a){a.preventDefault();x=a.pageX;y=a.pageY;d=0};c.ontouchend=function(a){a.preventDefault();d=-1};this.check=function(){if(m>0){m++;g=a;h=b;d=0;i=0}a=e;b=f;e=g;f=h;l=d;if(d!=0)d=-1;i=k;k=0;j=o(a,b,e,f);n=Math.sqrt(Math.pow(Math.abs(e-a),2)+Math.pow(Math.abs(f-b),2));if(a-e==0&&b-f==0)j="NaN";var c={};c.x=g;c.y=h;c.button=l;c.wheel=i;c.deg=j;c.distance=n;return c};this.check_last=function(){var a={};a.x=g;a.y=h;a.button=l;a.wheel=i;a.deg=j;a.distance=n;return a};this.input_pause=function(a){if(wait_count>30)a=30;if(wait_count<0)a=0;m=a};this.draw=function(){var c=canvas.width,d=canvas.height,g=j;context.fillStyle="black";context.fillRect(0,0,canvas.width,canvas.height);context.fillStyle="white";context.fillRect(5,5,canvas.width-10,canvas.height-10);context.fillStyle="green";context.fillText(e+" "+f+" "+c+" "+d+" "+g,32,32);var h="OOO";switch(l){case 0:h="@OO";break;case 1:h="O@O";break;case 2:h="OO@"}context.fillText("b:"+h+" w:"+i,32,232);context.beginPath();context.moveTo(c/2,d/2);context.lineTo(e-a+c/2,f-b+d/2);context.strokeStyle="black";context.stroke();context.beginPath();context.arc(c/2,d/2,5,0,2*Math.PI,true);context.strokeStyle="black";context.stroke();r=Math.sqrt(Math.pow(Math.abs(e-a),2)+Math.pow(Math.abs(f-b),2));context.beginPath();context.arc(c/2,d/2,r,0,2*Math.PI,true);context.strokeStyle="black";context.stroke();var k=0,m=0;if(g!="NaN"){g=q(g-90);k=Math.cos(g)*50;m=Math.sin(g)*50}context.beginPath();context.arc(c/2+k,d/2+m,20,0,2*Math.PI,true);context.fillStyle="orange";context.fill();var n=context.getImageData(0,0,canvas.width,canvas.height)};function o(f,g,d,e){var a,b=d-f,c=e-g;if(b==0)if(c>=0)a=180;else a=0;else{a=p(Math.atan(c/b));if(b>=0&&c>=0)a=90+a;if(b>=0&&c<0)a=90+a;if(b<0&&c<0)a=270+a;if(b<0&&c>=0)a=270+a}return a}function q(a){return a*(Math.PI/180)}function p(a){return a*(180/Math.PI)}}function inputKeyboard(){var a=[];window.onblur=function(){a=[]};window.onkeydown=function(b){a[b.keyCode]=true};window.onkeyup=function(b){a[b.keyCode]=false};this.check=function(){return a};this.state=function(){st="";for(var b in a)st+="["+b+"]"+(a[b]?"*":".");return st}}function sce_item_direct_homing(){this.init=function(b,a){a.vector=0;a.vset(16);a.display_size=1};this.move=function(c,a){switch(a.frame){case 1:a.get_target(98);break;case 3:a.get_target(98);a.vector=a.target_v();case 4:if(Boolean(this.target)){var b=a.target_d(a.target.x,a.target.y);b=b<15?b+1:16;a.vset(b)}case 8:a.frame=2}a.frame++;return a.sc_move()}}function sce_item_near_homing(){this.init=function(b,a){a.vset(0);a.get_target(98)};this.move=function(c,a){!Boolean(this.target)&&a.get_target(98);if(Boolean(this.target)){var b=a.target_d(a.target.x,a.target.y);if(b<40){a.vector=a.target_v();a.vset(4)}}return a.sc_move()}}function sce_item_movingstop(){this.init=function(b,a){a.vset(.1)};this.move=function(b,a){a.frame>100&&a.vset(0);a.frame++;return a.sc_move()}}function gameLayout(){this.score_x=640-180;this.score_y=16;this.hiscore_x=640-180;this.hiscore_y=0;this.status_x=640-120;this.status_y=32;this.combo_x=0;this.combo_y=32;this.itemchain_x=0;this.itemchain_y=24;this.zanki_x=20;this.zanki_y=480-16;this.time_x=640-12*10;this.time_y=479-16;this.stage_x=640-12*10;this.stage_y=479-32}function main_r(){var i=60,c=new deviceControl,b=c.graphics1,a=c.graphics2,q=new sceneControl(c),v=c.mouse_state,x=c.key_state,u=new Number(0),r=new Date,g=r.getTime(),o=1,e,m,n,k,l=r.getTime(),d=0,h=0,f,w=0,p=false,s=false;j();function t(){b.readystate_check();a.readystate_check();var c=b.sprite_texture_ready,d=b.character_texture_ready,e=a.sprite_texture_ready,f=a.character_texture_ready;a.print("Load_check",0,20);st="w1s_"+(c?"ready":".");a.print(st,0,40);st="w1t_"+(d?"ready":".");a.print(st,0,60);st="w2s_"+(e?"ready":".");a.print(st,0,80);st="w2t_"+(f?"ready":".");a.print(st,0,100);var h=new Date;a.print(Math.floor((h.getTime()-g)/1e3)+".",0,120);a.clear("black");a.draw();a.reset();return c&&d&&e&&f?true:false}function j(){if(!p){e=16;s=t()}if(s){p=true;var a=new Date,y=a.getTime(),w=[];w.push("runningtime:"+m);var r=v.check();if(r.wheel!=0)u+=r.wheel>0?1:-1;var B=r.x,C=r.y,z=false;if(r.button==0)z=true;r.button==1;var A="fps:"+1e3/f;f&&w.push(A.substring(0,8));for(var x in w)b.putchr8(w[x],0,0+8*x);q.step();b.clear();b.draw();b.reset();q.draw();c.gs.commit();a=new Date;d++;if(d>i)d=0;k=a.getTime()-l;l=a.getTime();h+=k;o=a.getTime();if(d==0){g=a.getTime();f=h/i;h=0}m=a.getTime()-y;n=Math.round(g+d*(1e3/i));e=n-o;if(e<=0)e=1}setTimeout(j,e)}}function cursur_draw(a){a.save();a.setTransform(1,0,0,1,this.x,this.y);a.rotate(3.6*(Math.PI/180)*this.mode);for(var b=0;b<4;b++){a.beginPath();a.moveTo(0,8);a.lineTo(0,24);var c=String(255-this.mode%25*5);a.strokeStyle="rgb("+c+", 128, 255)";a.rotate(45*(Math.PI/180));a.moveTo(0,16);a.lineTo(0,21);a.stroke();a.rotate(45*(Math.PI/180))}a.beginPath();a.arc(0,0,20,0,2*Math.PI,true);a.stroke();a.restore()}function mapSceControl(){var c,e,d,a=-5;this.enable=true;this.counter_runnning=true;this.flame=a;this.stage=1;var b,g,k,i,f,j;h(this.stage);function h(a){b=new Stage1_tod;g=b.scenario();k=b.bgImage();i=b.bgLayout();f=b.initial(a);j=b.bgPtn()}this.change=function(a){this.stage=a;c=[];h(a);e=g;d=f};this.bgImage=function(){return k};this.bgPtn=function(){return j};this.mapChip=function(){return i};this.init=function(){this.stage=1;c=[];h(this.stage);e=g;d=f};this.reset=function(){this.enable=true;this.counter_runnning=true;a=-5;this.start(false);this.start(true)};this.step=function(g){if(!this.enable)return;if(this.counter_runnning)a++;a=a>7200?7200:a;for(var f in e){var b=e[f];if(b.count<a)continue;if(b.count==a){if(b.x<0&&b.y<0){a=0;break}this.add(b.x,b.y,b.r,b.ch,b.sc)}if(b.count>a)break}for(f in c){var d=c[f];g.set_s(d.x,d.y,d.r,d.ch,d.sce,d.id)}c=[];this.flame=a};this.add=function(f,g,e,d,b,a){if(!this.enable)return;ev={};ev.x=f;ev.y=g;ev.r=e;ev.ch=d;ev.sce=b;if(Boolean(a))ev.id=a;c.push(ev)};this.start=function(b){for(var c in d){var a=d[c];b==a.s&&this.add(a.x,a.y,a.r,a.ch,a.sc)}}}function mapScenro(){var d=[[-1,240,608,0,8,0],[-1,208,608,0,17,10],[-1,272,608,0,17,10],[-1,240,240,0,28,18],[-1,320,320,0,29,19],[50,240,0,180,11,1],[100,440,140,225,10,1],[100,40,140,135,9,1],[120,440,140,225,10,1],[120,40,140,135,9,1],[140,440,140,225,10,1],[140,40,140,135,9,1],[160,440,140,225,10,1],[160,40,140,135,9,1],[180,440,140,225,10,1],[180,40,140,135,9,1],[250,140,0,180,2,1],[250,340,0,180,3,1],[280,140,0,180,2,1],[280,340,0,180,3,1],[310,140,0,180,2,1],[310,340,0,180,3,1],[340,140,0,180,2,1],[340,340,0,180,3,1],[390,464,200,0,"effect_warnning_mark",1],[440,479,200,270,15,1],[450,16,220,0,"effect_warnning_mark",1],[500,1,220,90,15,1],[700,240,0,180,23,14],[900,120,0,180,19,1],[900,360,0,180,19,1],[1120,480,0,180,37,2],[1500,240,40,180,34,14],[1600,480,0,180,53,2],[1700,480,0,180,54,2],[1800,-1,-1,180,0,4],[6e5,-1,-1,0,0,0]],c=[];for(var e in d){var b=d[e],a={};a.count=b[0];a.x=b[1]*.875;a.y=b[2]*.75;a.r=b[3];a.sc=b[4];a.ch=b[5];c.push(a)}return c}function mapBgImage(){var a=new Image;a.src="pict/sky.jpg";return a}function mapBgLayout(){var d=[[0,0,0],[0,0,480],[0,0,960]],c=[];for(var e in d){var b=d[e],a={};a.no=b[0];a.x=b[1];a.y=b[2];c.push(a)}return c}function mapInitial(){}function sce_message_billboard(b,a){this.init=function(d,c){c.vset(0);c.type=5;this.normal_draw_enable=false;this.custom_draw_enable=true;c.p_count=0;c.mes_col=0;c.mes_line=0;c.p_wait=a;c.p_endflag=false;c.p_st=b;c.x=c.gt.world_x+1;c.y=c.gt.world_y+1};this.move=function(b,a){a.x=a.gt.world_x+1;a.y=a.gt.world_y+1;a.p_count--;if(a.p_count<=0){if(a.p_endflag)a.status=0;a.mes_col++;if(a.mes_col>a.p_st[a.mes_line].length){a.mes_col=0;a.mes_line++;if(a.mes_line>a.p_st.length-1){a.mes_line=a.p_st.length-1;a.mes_col=a.p_st[a.mes_line].length;a.p_endflag=true}}a.p_count=a.p_wait+(a.p_endflag?40:0)}return a.sc_move()};this.draw=function(c,b){for(var a=0;a<=b.mes_line;a++)if(a<b.mes_line)c.putchr(b.p_st[a],95,150+16*a);else{var d=b.p_st[a].slice(0,b.mes_col+1);c.putchr(d,95,150+16*a)}}}function sce_message_small(a){this.init=function(b,a){a.vset(1);a.type=5;this.normal_draw_enable=false;this.custom_draw_enable=true;a.w_st=a.id;a.x-=a.w_st.length*8/2;a.display_size=1};this.move=function(b,a){if(a.frame>50)a.status=0;a.display_size=1+a.frame/150;a.frame++;return a.sc_move()};this.draw=function(d,b){var c=b.gt.worldtoView(b.x,b.y);d.putchr8c(b.w_st,c.x,c.y,a,b.display_size)}}function sce_message_normal(a){this.init=function(c,b){b.vset(0);b.type=5;this.normal_draw_enable=false;this.custom_draw_enable=true;b.w_st=b.id;b.x-=b.w_st.length*12/2;b.wait=a;b.display_size=1};this.move=function(c,b){if(b.frame>a)b.status=0;b.display_size=1+b.frame/60;b.frame++;return b.sc_move()};this.draw=function(c,a){var b=a.gt.worldtoView(a.x,a.y);c.putchr(a.w_st,b.x,b.y,a.display_size)}}function sce_message_bosstriger(){this.init=function(b,a){a.vset(0);a.type=5;this.normal_draw_enable=false;a.x=a.gt.world_x+1;a.y=a.gt.world_y+1};this.move=function(b,a){a.x=a.gt.world_x+1;a.y=a.gt.world_y+1;a.SIGNAL(6055);a.status=0;return a.sc_move()}}function motionPattern(){var b=[],a=0;b[a]={};b[a].wait=0;b[a].pattern=[["Space",0,0]];a=1;b[a]={};b[a].pattern=[["Ship",-1,-1]];a=2;b[a]={};b[a].pattern=[["Ship_r",2,0]];a=3;b[a]={};b[a].pattern=[["Ship_r",0,0]];a=4;b[a]={};b[a].wait=18;b[a].pattern=[["Enemy1",0,0],["Enemy2",0,0],["Enemy3",0,0]];a=5;b[a]={};b[a].wait=10;b[a].pattern=[["S_Tama",0,0],["S_Tama",2,0],["S_Tama",3,0],["S_Tama",1,0]];a=6;b[a]={};b[a].pattern=[["MoTama",0,0]];a=7;b[a]={};b[a].pattern=[["MbTama",0,0]];a=8;b[a]={};b[a].pattern=[["YaTama",-1,-1]];a=9;b[a]={};b[a].pattern=[["Zanki",-1,-1]];a=10;b[a]={};b[a].wait=10;b[a].pattern=[["Bomb3",0,0],["Bomb1",0,0],["Bomb2",0,0],["Bomb3",0,0],["Bomb4",0,0],["Bomb5",0,0]];a=11;b[a]={};b[a].wait=5;b[a].pattern=[["Powup1",0,0],["Powup2",0,0],["Powup4",0,0],["Powup3",1,0],["Powup2",1,0],["Powup1",1,0],["Powup2",1,0],["Powup3",1,0],["Powup2",0,0]];a=12;b[a]={};b[a].pattern=[["Boss",-1,-1]];a=13;b[a]={};b[a].pattern=[["Wave",0,0]];a=14;b[a]={};b[a].pattern=[["Missile",-1,-1]];a=15;b[a]={};b[a].pattern=[["Option",0,0]];a=15;b[a]={};b[a].wait=20;b[a].pattern=[["Option1",0,0],["Option1",1,0],["Option2",1,0],["Option3",0,0],["Option2",0,0]];a=16;b[a]={};b[a].pattern=[["Boardw",0,0]];a=17;b[a]={};b[a].pattern=[["Boardh",0,0]];a=18;b[a]={};b[a].pattern=[["Bonus",0,0]];a=19;b[a]={};b[a].pattern=[["MiniB",-1,-1]];a=20;b[a]={};b[a].pattern=[["Wave",-1,-1]];a=21;b[a]={};b[a].pattern=[["Laser",-1,-1]];a=22;b[a]={};b[a].pattern=[["pBall",0,0]];a=23;b[a]={};b[a].pattern=[["Laser2",-1,-1]];a=24;b[a]={};b[a].pattern=[["Gunpod",0,0]];a=25;b[a]={};b[a].pattern=[["Warn",0,0]];a=26;b[a]={};b[a].wait=5;b[a].pattern=[["Coin1",0,0],["Coin2",0,0],["Coin3",0,0],["Coin4",0,0],["Coin3",2,0],["Coin2",2,0],["Coin1",2,0]];a=27;b[a]={};b[a].pattern=[["Kobold",0,0]];a=28;b[a]={};b[a].pattern=[["Warn",0,0]];a=29;b[a]={};b[a].pattern=[["Bonus_r",0,0]];a=30;b[a]={};b[a].pattern=[["Bonus_g",0,0]];a=1;b[a]={};b[a].wait=18;b[a].pattern=[["Mayura1",0,0],["Mayura2",0,0],["Mayura3",0,0],["Mayura4",0,0]];a=2;b[a]={};b[a].wait=18;b[a].pattern=[["Mayura1",2,0],["Mayura2",2,0],["Mayura3",2,0],["Mayura4",2,0]];a=4;b[a]={};b[a].wait=18;b[a].pattern=[["Unyuu1",0,0],["Unyuu2",0,0]];a=5;b[a]={};b[a].wait=18;b[a].pattern=[["Unyuu1",2,0],["Unyuu2",2,0]];a=7;b[a]={};b[a].wait=18;b[a].pattern=[["Fire1",0,0],["Fire2",0,0]];a=12;b[a]={};b[a].wait=10;b[a].pattern=[["Down5",0,0],["Down4",0,0],["Down3",0,0],["Down2",0,0],["Down1",0,0],["Down2",0,0],["Down3",0,0],["Down4",0,0],["Down5",0,0]];a=11;b[a]={};b[a].wait=15;b[a].pattern=[["Zap1",0,0],["Zap2",0,0],["Zap3",0,0],["Zap4",0,0]];a=26;b[a]={};b[a].wait=10;b[a].pattern=[["Ball1",0,0],["Ball2",0,0],["Ball3",0,0],["Ball2",0,0]];return b}function sce_player(){this.init=function(b,a){a.triger=10;a.int_shot=0;a.custom_draw_enable=true;a.gt.viewpos(a.x-a.gt.viewwidth/2,a.y-a.gt.viewheight/2);a.display_size=1.5;a.old_x=a.x;a.old_y=a.y;a.doorflag=false};this.draw=a;this.move=function(h,a){a.frame++;if(a.frame<=90){a.hp=10;a.damageflag=false}a.vset(0);var d=6;if(Boolean(a.key_state[37]))if(a.key_state[37]){a.vector=270;a.vset(d)}else a.vset(0);if(Boolean(a.key_state[38]))if(a.key_state[38]){a.vector=0;a.vset(d)}if(Boolean(a.key_state[39]))if(a.key_state[39]){a.vector=90;a.vset(d)}if(Boolean(a.key_state[40]))if(a.key_state[40]){a.vector=180;a.vset(d)}if(a.vector>180)a.mp=2;else a.mp=1;var k=a.vector;a.triger--;if(a.triger<=0){a.shot=0;a.triger=5}var b=0;for(var c in a.item)if(c==20)b=a.item[c];var i=false;if(Boolean(a.key_state[90]))if(a.key_state[90])i=true;if(i)if(a.shot==0){a.shot=1;if(b>0){a.set_object(6);a.item[20]--}a.triger=30}a.damageflag&&a.set_object_ex(20,a.x,a.y,0,42,"Damege!");a.damageflag=false;if(a.mapCollision!=true){a.old_x=a.x;a.old_y=a.y;a.x+=a.vx;a.y+=a.vy}else{a.x=a.old_x;a.y=a.old_y}var e=a.gt.worldtoView(a.x,a.y),f=0,g=0;if(e.x<240&&a.vx<0)f=1;if(e.x>h.cw-240&&a.vx>0)f=1;if(e.y<240&&a.vy<0)g=1;if(e.y>h.ch-240&&a.vy>0)g=1;a.gt.viewpos(a.gt.world_x+a.vx*f,a.gt.world_y+a.vy*g);if(a.doorflag){if(b>=3){a.item[20]-=3;a.SIGNAL(835);a.hp=10}a.doorflag=false}var j=0;if(a.status==2){if(a.config.itemreset){if(b==0)b=1;for(c=1;c<=b;c++)this.set_object_ex(20,a.x,a.y,Math.floor(Math.random()*360),38)}a.display_size=2.5;a.change_sce(7)}if(a.status==0)j=1;return j};function a(c,b){var a={};a.x=640-12*10-25;a.y=458;a.sr=(360*((b.maxhp-b.hp)/b.maxhp)-90)*(Math.PI/180);a.df=b.damageflag;a.r=15;a.draw=function(a){a.beginPath();a.strokeStyle="gray";a.lineWidth="10";a.arc(this.x,this.y,this.r,0,2*Math.PI,false);a.stroke();a.beginPath();a.lineWidth=8;a.strokeStyle=this.df?"red":"limegreen";a.arc(this.x,this.y,this.r,this.sr,1.5*Math.PI,false);a.stroke();a.lineWidth="3"};c.putFunc(a);b.damageflag=false}}function sce_player_start(){this.init=function(b,a){a.type=98;a.vector=0;a.vset(8);a.gt.viewpos(a.x-210,a.y-240)};this.move=function(b,a){a.hp=10;switch(a.frame){case 30:a.vector=180;a.vset(4);break;case 58:case 60:a.vset(3);a.hp=10;a.change_sce(1)}a.frame++;return a.sc_move()}}function scenario(){for(var d={},a=[],c=[],b=[],e=0;e<=37;e++){a[e]=function(b,a){a.vset(5)};b[e]=function(b,a){return a.sc_move()}}w=new sce_player;a[1]=w.init;b[1]=w.move;c[1]=w.draw;a.player=w.init;b.player=w.move;c.player=w.draw;w=new sce_ememy_move_n(45,180);a[2]=w.init;b[2]=w.move;a.ememy_move_n_r=w.init;b.ememy_move_n_r=w.move;w=new sce_ememy_move_n(315,180);a[3]=w.init;b[3]=w.move;a.ememy_move_n_l=w.init;b.ememy_move_n_l=w.move;w=new sce_common_vset(4);a[4]=w.init;b[4]=w.move;a.common_vset4=w.init;b.common_vset4=w.move;w=new sce_effect_vanish;a[6]=w.init;b[6]=w.move;a.effect_vanish=w.init;b.effect_vanish=w.move;w=new sce_effect_bomb;a[7]=w.init;b[7]=w.move;a.effect_bomb=w.init;b.effect_bomb=w.move;w=new sce_effect_hit;a.effect_hit=w.init;b.effect_hit=w.move;w=new sce_ememy_turn(-10);a[9]=w.init;b[9]=w.move;a.ememy_turn_r=w.init;b.ememy_turn_r=w.move;w=new sce_ememy_turn(10);a[10]=w.init;b[10]=w.move;a.ememy_turn_l=w.init;b.ememy_turn_l=w.move;w=new sce_ememy_change_s;a[11]=w.init;b[11]=w.move;a.ememy_change_s=w.init;b.ememy_change_s=w.move;w=new sce_common_vset(6);a[12]=w.init;b[12]=w.move;a.common_vset6=w.init;b.common_vset6=w.move;w=new sce_common_vset(16);a[13]=w.init;b[13]=w.move;a.common_vset16=w.init;b.common_vset16=w.move;w=new sce_en_bullet_homing;a[14]=w.init;b[14]=w.move;a.en_bullet_homing=w.init;b.en_bullet_homing=w.move;w=new sce_ememy_moveshot;a[15]=w.init;b[15]=w.move;a.ememy_moveshot_1=w.init;b.ememy_moveshot_1=w.move;w=new sce_en_bullet_random;a[18]=w.init;b[18]=w.move;a.en_bullet_random=w.init;b.en_bullet_random=w.move;w=new sce_ememy_randomshot;a[19]=w.init;b[19]=w.move;a.sce_ememy_randomshot=w.init;b.sce_ememy_randomshot=w.move;w=new sce_common_vset(0);a[22]=w.init;b[22]=w.move;a.common_vset0=w.init;b.common_vset0=w.move;w=new sce_common_vset(2);a[24]=w.init;b[24]=w.move;a.common_vset2=w.init;b.common_vset2=w.move;w=new sce_common_vset(8);a[25]=w.init;b[25]=w.move;a.common_vset8=w.init;b.common_vset8=w.move;w=new sce_common_vset(10);a[26]=w.init;b[26]=w.move;a.common_vset10=w.init;b.common_vset10=w.move;w=new sce_item_direct_homing;a[30]=w.init;b[30]=w.move;a.item_direct_homing=w.init;b.item_direct_homing=w.move;w=new sce_en_bullet_accel;a[33]=w.init;b[33]=w.move;a.en_bullet_accel=w.init;b.en_bullet_accel=w.move;w=new sce_item_near_homing;a[36]=w.init;b[36]=w.move;a.item_near_homing=w.init;b.item_near_homing=w.move;w=new sce_item_movingstop;a[38]=w.init;b[38]=w.move;a.item_movingstop=w.init;b.item_movingstop=w.move;w=new sce_message_small(0);a[39]=w.init;b[39]=w.move;c[39]=w.draw;a.message_small_w=w.init;b.message_small_w=w.move;c.message_small_w=w.draw;w=new sce_message_small(1);a[42]=w.init;b[42]=w.move;c[42]=w.draw;a.message_small_r=w.init;b.message_small_r=w.move;c.message_small_r=w.draw;w=new sce_message_small(2);a[43]=w.init;b[43]=w.move;c[43]=w.draw;a.message_small_g=w.init;b.message_small_g=w.move;c.message_small_g=w.draw;w=new sce_message_small(3);a[44]=w.init;b[44]=w.move;c[44]=w.draw;a.message_small_b=w.init;b.message_small_b=w.move;c.message_small_b=w.draw;w=new sce_effect_bombcircle("rgba(255, 64, 64, 0.7)");a[47]=w.init;b[47]=w.move;c[47]=w.draw;a.effect_bombcircle_r=w.init;b.effect_bombcircle_r=w.move;c.effect_bombcircle_r=w.draw;w=new sce_effect_bombcircle("rgba(255, 255, 255, 0.7)");a[48]=w.init;b[48]=w.move;c[48]=w.draw;a.effect_bombcircle_w=w.init;b.effect_bombcircle_w=w.move;c.effect_bombcircle_w=w.draw;w=new sce_en_bullet_hominglaser;a[49]=w.init;b[49]=w.move;a.en_bullet_hominglaser=w.init;b.en_bullet_hominglaser=w.move;w=new sce_en_bullet_infolaser;a[51]=w.init;b[51]=w.move;c[51]=w.draw;a.en_bullet_infolaser=w.init;b.en_bullet_infolaser=w.move;c.en_bullet_infolaser=w.draw;w=new sce_en_bullet_turn;a[52]=w.init;b[52]=w.move;a.en_bullet_turn=w.init;b.en_bullet_turn=w.move;w=new sce_common_signal(835);a[54]=w.init;b[54]=w.move;a.common_signal_result=w.init;b.common_signal_result=w.move;w=new sce_common_signal(5963);a.common_signal_gover=w.init;b.common_signal_gover=w.move;w=new sce_message_billboard(["=== Time Over. ==="],0);a.message_billboard_tover=w.init;b.message_billboard_tover=w.move;c.message_billboard_tover=w.draw;w=new sce_effect_warnning_mark;a[55]=w.init;b[55]=w.move;a.effect_warnning_mark=w.init;b.effect_warnning_mark=w.move;w=new sce_en_bullet_laser_tail;a[56]=w.init;b[56]=w.move;a.en_bullet_laser_tail=w.init;b.en_bullet_laser_tail=w.move;w=new sce_message_normal(60);a[57]=w.init;b[57]=w.move;c[57]=w.draw;a.message_normal_60=w.init;b.message_normal_60=w.move;c.message_normal_60=w.draw;w=new sce_message_bosstriger;a[58]=w.init;b[58]=w.move;a.message_bosstriger=w.init;b.message_bosstriger=w.move;w=new sce_ememy_move_std;a.ememy_move_std=w.init;b.ememy_move_std=w.move;d.init=a;d.draw=c;d.move=b;return d}function sceneBase(a){var i=a.graphics1,h=a.graphics2;this.init=d;this.reset=b;this.step=e;this.draw=c;function d(){}function b(){}function e(){return 0}function c(){}}function sceneConfig(l){var j=l.graphics1,n=l.graphics2,c=l.text,G=l.mouse_state,F=l.key_state;this.init=z;this.reset=x;this.step=A;this.draw=y;var f;this.score=0;this.config={};var b=[],d=[],t=[],k,q=false,p=false,E,D;function h(){this.title="button";this.x=0;this.y=0;this.w=100;this.h=16;this.select=false;this.click=false;this.setup=function(b,d,e,c,a){this.title=b;this.x=d;this.y=e;this.w=c;this.h=a;this.select=false;this.click=false;this.lamp=false};this.status_reset=function(){this.select=false;this.click=false};this.func=function(){return 0}}function B(){var d,b=[];this.button=b;var e,g,i;this.setup=function(j,p,f,k,l,n,o){d=j;e=f;g=n;i=o;m=new h;m.setup(p,k,l,120,16);m.msg=f;a.push(m);b.push(m);for(var c=0;c<2;c++){m=new h;m.setup(c==0?"  On":"  Off",k+160+80*c,l,80,16);m.msg=f+(c==0?"\u6709\u52b9":"\u7121\u52b9");m.sw=c==0?true:false;m.num=j;a.push(m);b.push(m)}};this.set=function(a){d=a};this.result=function(){if(b[0].select||b[1].select||b[2].select){if(b[1].click){d=true;f=true}if(b[2].click){d=false;f=true}c.clear();c.reset();c.print(e,g,i,"white");c.draw()}if(d){b[1].lamp=true;b[2].lamp=false}else{b[1].lamp=false;b[2].lamp=true}return d}}function o(){var d,b=[];this.button=b;var g,i,j,e;this.setup=function(k,l,f,n,o,p,q){d=k;e=l;g=f;i=p;j=q;m=new h;m.setup(l,n,o,120,16);m.msg=f;a.push(m);b.push(m);for(var c=0;c<2;c++){m=new h;m.setup(c==0?"  +1":"  -1",n+160+80*c,o,80,16);m.msg=f;m.sw=c==0?1:-1;m.num=k;a.push(m);b.push(m)}};this.set=function(a){d=a;b[0].title=e+d};this.result=function(){var a=d;if(b[0].select||b[1].select||b[2].select){if(b[1].click){d+=b[1].sw;b[1].click=false;f=true;b[1].lamp=true;b[2].lamp=false}if(b[2].click){d+=b[2].sw;b[2].click=false;f=true;b[1].lamp=false;b[2].lamp=true}b[0].title=e+d;c.clear();c.reset();c.print(g+d,i,j,"white");c.draw()}return d}}var a=[],r=["FullPower.","SideShot.","ItemReset.","Option.","---.","Stage."],u=["\u30d1\u30ef\u30fc\u30a2\u30c3\u30d7\u6700\u5927\u3067\u958b\u59cb : ","\u5f3e\u6d88\u3057\u5f3e[\u25ce]\u3092\u4f7f\u7528 : ","\u6b7b\u3093\u3060\u3068\u304d\u306b\u30a2\u30a4\u30c6\u30e0\u653e\u51fa : ","\u652f\u63f4\u6a5f(\u30aa\u30d7\u30b7\u30e7\u30f3)\u4f7f\u7528 : ","\u672a\u4f7f\u7528 : ","\u958b\u59cb\u9762\u306e\u9078\u629e : "],i=[0,0,0,0,1,1];d[5]=1;for(var g=[],v=60,w=180,e=0;e<r.length;e++){if(i[e]==0){var s=new B;s.setup(e,r[e],u[e],v,w+e*20,100,320)}else{var s=new o;s.setup(e,r[e],u[e],v,w+e*20,100,320)}g.push(s)}m=new h;m.setup("Save.",100,360,120,16);m.msg="Save.";m.func=function(){q=true;f=true;return 0};a.push(m);m=new h;m.setup("Reset.",100,380,120,16);m.msg="Reset.";m.func=function(){p=true;f=true;return 0};a.push(m);m=new h;m.setup("Exit.",100,400,120,16);m.msg="Exit.";m.jp=2;m.func=function(){c.clear();c.reset();return this.jp};a.push(m);var C,H=new Number(0);this.config_load=function(){if(Boolean(localStorage)){for(var c=["fullpower","sideshot","itemreset","option","dummy","startstage"],e=false,a=0;a<=3;a++)if(Boolean(localStorage.getItem(c[a]))){e=true;b[a]=localStorage.getItem(c[a])=="on"?true:false;this.config[c[a]]=b[a]}if(Boolean(localStorage.getItem(c[5]))){e=true;d[5]=parseInt(localStorage.getItem(c[5]));this.config[c[5]]=d[5]}}};function z(){this.config.fullpower=false;this.config.sideshot=true;this.config.itemreset=true;this.config.option=true;this.config.startstage=1;this.config.cold=true;this.config.debug=false;b[0]=this.config.fullpower;b[1]=this.config.sideshot;b[2]=this.config.itemreset;b[3]=this.config.option;b[4]=false;b[5]=false;d[4]=0;d[5]=this.config.startstage}function x(){for(var c in a){a[c].sel=false;a[c].lamp=false}E=false;D=0;C=0;n.clear("darkblue");cl={};cl.w=j.cw;cl.h=j.ch;cl.draw=function(a){var c=this.h;if(c<this.w)c=this.w;a.beginPath();for(var b=0;b<c;b+=16){a.moveTo(b,0);a.lineTo(b,this.h);a.moveTo(0,b);a.lineTo(this.w,b)}a.strokeStyle="lightgray";a.stroke()};n.putFunc(cl);n.draw();n.reset();for(c in d)if(Boolean(d[c]))t[c]=d[c];for(var c=0;c<i.length;c++)if(i[c]==0)g[c].set(b[c]);else{var e=new o;g[c].set(d[c])}f=true}function A(){k=[];var h=G.check_last(),m=F.check(),r=h.x,s=h.y;if(h.button==0&&!f)for(var e in a){a[e].click=false;if(a[e].select){a[e].click=true;var j=a[e].func();if(j!=0)return j}}else for(e in d)if(Boolean(d[e]))t[e]=d[e];if(h.button==-1)f=false;var l=-1;for(e in a)if(h.x>=a[e].x&&h.x<=a[e].x+a[e].w&&h.y>=a[e].y&&h.y<=a[e].y+a[e].h){a[e].select=true;l=e}else a[e].select=false;k.push("== Configration ==");k.push("-----------------");for(e in g){b[e]=g[e].result();if(i[e]==1)d[e]=b[e]}this.config.fullpower=b[0];this.config.sideshot=b[1];this.config.itemreset=b[2];this.config.option=b[3];this.config.startstage=d[5];if(p){b[0]=false;b[1]=true;b[2]=true;b[3]=true;b[4]=false;b[5]=false;d[5]=1;c.clear();c.reset();c.print("\u8a2d\u5b9a\u521d\u671f\u5316\u3057\u307e\u3057\u305f\u3002",100,320,"white");if(Boolean(localStorage)){localStorage.clear();c.print("\u30ed\u30fc\u30ab\u30eb\u30b9\u30c8\u30ec\u30fc\u30b8\u30af\u30ea\u30a2\u3002",100,340,"white")}else c.print("\u30ed\u30fc\u30ab\u30eb\u30b9\u30c8\u30ec\u30fc\u30b8\u304c\u4f7f\u7528\u3067\u304d\u306a\u3044?",100,340,"white");c.draw();for(var e=0;e<i.length;e++)if(i[e]==0)g[e].set(b[e]);else{var n=new o;g[e].set(d[e])}p=false}if(q){c.clear();c.reset();if(Boolean(localStorage)){localStorage.setItem("fullpower",this.config.fullpower?"on":"off");localStorage.setItem("sideshot",this.config.sideshot?"on":"off");localStorage.setItem("itemreset",this.config.itemreset?"on":"off");localStorage.setItem("option",this.config.option?"on":"off");localStorage.setItem("startstage",new String(this.config.startstage));c.print("\u8a2d\u5b9a\u3092\u30bb\u30fc\u30d6\u3057\u307e\u3057\u305f\u3002",100,320,"white")}else c.print("\u30ed\u30fc\u30ab\u30eb\u30b9\u30c8\u30ec\u30fc\u30b8\u304c\u4f7f\u7528\u3067\u304d\u306a\u3044?",100,320,"white");c.draw();q=false}return 0}function h(){this.title="button";this.x=0;this.y=0;this.w=100;this.h=16;this.select=false;this.click=false;this.setup=function(b,d,e,c,a){this.title=b;this.x=d;this.y=e;this.w=c;this.h=a;this.select=false;this.lamp=false;this.click=false};this.status_reset=function(){this.select=false;this.click=false};this.func=function(){return 0}}function y(){for(var d in k)j.putchr(k[d],0,100+16*d);for(var b in a){if(a[b].lamp){var c={};c.x=a[b].x;c.y=a[b].y;c.w=a[b].w;c.h=a[b].h;c.draw=function(a){a.beginPath();a.fillStyle="orange";a.fillRect(this.x,this.y,this.w,this.h)};j.putFunc(c)}if(a[b].select)j.putchr(a[b].title,a[b].x-4,a[b].y-1);else j.putchr(a[b].title,a[b].x,a[b].y)}}}function sceneControl(d){var a=[];a[1]=new gameScene(d);a[2]=new sceneTitle(d);a[3]=new sceneGover(d);a[4]=new sceneConfig(d);a[5]=new sceneResult(d);for(var e in a)a[e].init();var f=a[1].result,g=a[4].config;a[1].score_load();a[4].config_load();for(var e in a){a[e].result=f;a[e].config=g}var h=a[2],c=2,b=c;this.step=function(){if(c!=0){var f=a[b].result,e=a[b].config,d=false;if(c>=10){c=c%10;d=true}b=c;a[b].reset(d);a[b].result=f;a[b].config=e}c=a[b].step()};this.draw=function(){a[b].draw()}}function sceneGover(e){var j=e.graphics1,c=e.graphics2,r=e.mouse_state,q=e.key_state;this.init=o;this.reset=m;this.step=p;this.draw=n;var f,g=0,i,l,h,k,d,a=[],b={};b.title="Continue.";b.x=320-50;b.y=180;b.w=120;b.h=16;b.sel=false;b.func=function(){return 11};a.push(b);b={};b.title="End.";b.x=320-50;b.y=200;b.w=120;b.h=16;b.sel=false;b.func=function(){return 2};a.push(b);function o(){}function m(){for(var b in a)a[b].sel=false;l=false;h=2;k=0;var o={};o.cw=c.cw;o.ch=c.ch;o.draw=function(a){for(var b=0;b<this.ch;b+=4){a.beginPath();a.moveTo(0,b);a.lineTo(this.cw,b);a.strokeStyle="black";a.stroke()}};c.putFunc(o);var i=this.result.score,j=[],m="";for(b=0;b<7;b++){var n=i%10;j[7-b]=n;i=(i-n)/10}for(b in j)m=m+""+j[b];c.putchr("Score:"+m,e.layout.score_x,e.layout.score_y);i=this.result.highscore;j=[];m="";for(b=0;b<7;b++){var n=i%10;j[7-b]=n;i=(i-n)/10}for(b in j)m=m+""+j[b];c.putchr("Hi-Sc:"+m,e.layout.hiscore_x,e.layout.hiscore_y);c.draw();c.reset();this.config.cold=true;f=true;g=30;d=1}function p(){i=[];var o=r.check_last(),b=q.check(),m=false;if(!f){if(Boolean(b[38]))if(b[38]){d--;if(d<0)d=a.length-1;f=true;g=10}if(b[40])if(b[40]){d++;if(d>a.length-1)d=0;f=true;g=10}var m=false;if(Boolean(b[90]))if(b[90])m=true}if(m&&!f)for(var e in a)if(a[e].sel){var n=a[e].func();if(n!=0)return n}if(g>0)g--;if(!m&&g==0)f=false;if(l){var j={};j.cw=c.cw;j.ch=c.ch;j.y1=c.ch/2-h;j.y2=c.ch/2+h;j.draw=function(a){a.strokeStyle="black";a.beginPath();a.moveTo(0,this.y1);a.lineTo(this.cw,this.y1);a.stroke();a.beginPath();a.moveTo(0,this.y2);a.lineTo(this.cw,this.y2);a.stroke()};c.putFunc(j);c.draw();c.reset();h+=8;if(c.ch/2-h<0)return k}for(e in a)if(e==d)a[e].sel=true;else a[e].sel=false;i.push("== Game Over ==");i.push("---------------");return 0}function n(){for(var b in a){if(a[b].sel){var c={};c.x=a[b].x;c.y=a[b].y;c.w=a[b].w;c.h=a[b].h;c.draw=function(a){a.beginPath();a.fillStyle="orange";a.fillRect(this.x,this.y,this.w,this.h)};j.putFunc(c)}j.putchr(a[b].title,a[b].x,a[b].y)}for(var d in i)j.putchr(i[d],320-72,132+16*d)}}function sceneResult(c){var i=c.graphics1,b=c.graphics2,q=c.text,r=c.mouse_state,p=c.key_state;this.init=n;this.reset=l;this.step=o;this.draw=m;var h,g,k,e,j,f=0,a=[],d={};d.title="[   ok.  ]";d.x=320-80;d.y=320;d.w=120;d.h=16;d.sel=false;d.func=function(){q.clear();return 11};a.push(d);function n(){}function l(){for(var d in a)a[d].sel=false;k=false;e=2;j=0;var n={};n.cw=b.cw;n.ch=b.ch;n.draw=function(a){for(var b=0;b<this.ch;b+=4){a.beginPath();a.moveTo(0,b);a.lineTo(this.cw,b);a.strokeStyle="darkblue";a.stroke()}};b.putFunc(n);var g=this.result.score,i=[],l="";for(d=0;d<7;d++){var m=g%10;i[7-d]=m;g=(g-m)/10}for(d in i)l=l+""+i[d];b.putchr("Score:"+l,c.layout.score_x,c.layout.score_y);g=this.result.highscore;i=[];l="";for(d=0;d<7;d++){var m=g%10;i[7-d]=m;g=(g-m)/10}for(d in i)l=l+""+i[d];b.putchr("Hi-Sc:"+l,c.layout.hiscore_x,c.layout.hiscore_y);b.draw();b.reset();h=true;f=0}function o(){g=[];var i=p.check(),l=false;if(Boolean(i[90]))if(i[90])l=true;f++;if(f>90)for(var d in a)if(a[d].sel){var m=a[d].func();if(m!=0)return m}if(!l)h=false;if(k){var c={};c.cw=b.cw;c.ch=b.ch;c.y1=b.ch/2-e;c.y2=b.ch/2+e;c.draw=function(a){a.strokeStyle="black";a.beginPath();a.moveTo(0,this.y1);a.lineTo(this.cw,this.y1);a.stroke();a.beginPath();a.moveTo(0,this.y2);a.lineTo(this.cw,this.y2);a.stroke()};b.putFunc(c);b.draw();b.reset();e+=8;if(b.ch/2-e<0)return j}for(d in a)if(!h)a[d].sel=true;var n=this.result.nowstage;g.push(" == Floor -"+n+"- Clear ==");return 0}function m(){for(var b in a){if(a[b].sel){var c={};c.x=a[b].x;c.y=a[b].y;c.w=a[b].w;c.h=a[b].h;c.draw=function(a){a.beginPath();a.fillStyle="orange";a.fillRect(this.x,this.y,this.w,this.h)};i.putFunc(c)}i.putchr(a[b].title,a[b].x,a[b].y)}for(var d in g)i.putchr(g[d],320-150,80+16*d+(90-f)+50)}}function sceneTitle(j){var i=j.graphics1,b=j.graphics2,v=j.mouse_state,t=j.key_state;this.init=q;this.reset=o;this.step=r;this.draw=p;for(var d,e=0,g,k,f,c=0,a=[],l=["GameStart."],u=[1],h=0;h<l.length;h++){m={};m.title=l[h];m.x=320-50;m.y=320+h*20+32;m.w=120;m.h=16;m.jp=u[h];m.sel=false;m.func=function(){return this.jp};a.push(m)}var s,n=new Number(0);function q(){n=0}function o(){for(var g in a)a[g].sel=false;k=false;f=0;s=0;b.clear("black");b.put("Mayura1",320-50+16,208);b.put("Unyuu1",320-50+16,240);b.put("Ball1",320-50+16,272);b.put("Unyuu3",320-50+16,304);b.putchr("Player",320,208-8);b.putchr("Enemy",320,240-8);b.putchr("Ball",320,272-8);b.putchr("Door",320,304-8);b.putchr8("Press <z> key to",320-50-8,336);b.draw();b.reset();this.config.cold=true;d=true;e=30;c=0}function r(){g=[];var l=v.check_last(),h=t.check();if(l.wheel!=0)n+=l.wheel>0?1:-1;var p=l.x,q=l.y,m=false;if(!d){if(Boolean(h[38]))if(h[38]){c--;if(c<0)c=a.length-1;d=true;e=10}if(h[40])if(h[40]){c++;if(c>a.length-1)c=0;d=true;e=10}var m=false;if(Boolean(h[90]))if(h[90])m=true}if(m&&!d)for(var i in a)if(a[i].sel){var o=a[i].func();if(o!=0)return o}l.button==1;if(e>0)e--;if(!m&&e==0)d=false;if(k){var j={};j.cw=b.cw;j.ch=b.ch;j.y1=b.ch/2-f;j.y2=b.ch/2+f;j.draw=function(a){a.strokeStyle="black";a.beginPath();a.moveTo(0,this.y1);a.lineTo(this.cw,this.y1);a.stroke();a.beginPath();a.moveTo(0,this.y2);a.lineTo(this.cw,this.y2);a.stroke()};b.putFunc(j);b.draw();b.reset();f+=4;if(b.ch/2-f<0)return 1}for(i in a)if(i==c)a[i].sel=true;else a[i].sel=false;g.push("==TowerOfDonichi==");g.push("------------------");return 0}function p(){for(var d in g)i.putchr(g[d],0,132+16*d);for(var b in a)if(a[b].sel){var c={};c.x=a[b].x;c.y=a[b].y;c.w=a[b].w;c.h=a[b].h;c.draw=function(a){a.beginPath();a.fillStyle="orange";a.fillRect(this.x,this.y,this.w,this.h)};i.putFunc(c);i.putchr(a[b].title,a[b].x-4,a[b].y-1)}else i.putchr(a[b].title,a[b].x,a[b].y)}}function star_draw(a){a.save();a.setTransform(1,0,0,1,this.x,this.y);a.rotate(1.8*(Math.PI/180)*this.mode);a.rotate(45*(Math.PI/180));a.beginPath();a.fillStyle="orange";a.fillRect(-80,-80,160,160);a.restore()}function Screen(n){var l=new Image;l.src="pict/cha.png";var e=new Image;e.src="pict/aschr.png";var a=[],g=[],b=document.createElement("canvas");b.id=n;b.width="640";b.height="480";b.style.margin="0";b.style.padding="0";b.style.position="absolute";b.style.top=0;b.style.left=0;var y=document.getElementsByTagName("body").item(0);y.appendChild(b);var d=document.getElementById(n),c=d.getContext("2d");this.cw=d.width;this.ch=d.height;var k=false,h=false;this.sprite_texture_ready=k;this.character_texture_ready=h;c.font="16px 'Arial'";l.onload=function(){k=true};e.onload=function(){h=true};this.readystate_check=function(){this.sprite_texture_ready=k;this.character_texture_ready=h};var A=spdata(),C=[];for(i=0;i<7;i++)for(j=0;j<16;j++){ptn={};ptn.x=12*j;ptn.y=16*i;ptn.w=12;ptn.h=16;g.push(ptn)}var m=[];for(i=0;i<7;i++)for(j=0;j<16;j++){ptn={};ptn.x=8*j;ptn.y=8*i+128;ptn.w=8;ptn.h=8;m.push(ptn)}for(var o=[],f=0;f<=3;f++){var p=[];for(i=0;i<7;i++)for(j=0;j<16;j++){ptn={};ptn.x=8*j+(f%2==0?0:128);ptn.y=8*i+128+(f>=2?64:0);ptn.w=8;ptn.h=8;p.push(ptn)}o[f]=p}this.lighter_enable=true;this.put=function(g,h,i,d,e,c,f){if(!Boolean(d))d=0;if(!Boolean(e))e=0;if(!Boolean(c))c=255;if(!Boolean(f))f=1;var b={};b.sp=g;b.x=h;b.y=i;b.m=d;b.r=e;b.alpha=c;b.z=f;b.draw=B;b.le=this.lighter_enable;a.push(b)};function B(a){a.save();var d=1,c=1;switch(this.m){case 1:d=-1;break;case 2:c=-1;break;case 3:d=-1;c=-1}var b=A[this.sp];a.setTransform(c,0,0,d,this.x,this.y);this.r!=0&&a.rotate(Math.PI/180*this.r);if(this.alpha==255)a.globalCompositeOperation="source-over";else if(this.le)a.globalCompositeOperation="lighter";a.globalAlpha=this.alpha*(1/255);a.drawImage(l,b.x,b.y,b.w,b.h,-b.w/2*this.z,-b.h/2*this.z,(0+b.w)*this.z,(0+b.h)*this.z);a.restore()}this.putPattern=function(d,c,g,h,f,e){var b={};b.gr=d;b.x=g;b.y=h;b.w=f;b.h=e;b.no=c;b.draw=z;a.push(b)};function z(b){var a=this.no;b.drawImage(this.gr,a.x,a.y,a.w,a.h,this.x,this.y,this.w,this.h)}this.print=function(d,e,f,c){if(!Boolean(c))c="limegreen";var b={};b.text=d;b.x=e;b.y=f;b.color=c;b.draw=x;a.push(b)};function x(a){a.fillStyle=this.color;a.fillText(this.text,this.x,this.y)}this.putchr=function(f,g,h,c){var e=false;if(!Boolean(c))c=1;else if(c!=1)e=true;for(i=0;i<f.length;i++){var d=f.charCodeAt(i);if(d>=32&&d<128){var b={};b.chrno=d-32;b.x=g+i*(12*c);b.y=h;if(!e)b.draw=w;else{b.z=c;b.draw=v}a.push(b)}}};function w(b){var a=g[this.chrno];b.drawImage(e,a.x,a.y,a.w,a.h,this.x,this.y,a.w,a.h)}function v(b){var a=g[this.chrno];b.drawImage(e,a.x,a.y,a.w,a.h,this.x,this.y,a.w*this.z,a.h*this.z)}this.putchr8=function(d,e,f){for(i=0;i<d.length;i++){var c=d.charCodeAt(i);if(c>=32&&c<128){var b={};b.chrno=c-32;b.x=e+i*8;b.y=f;b.draw=u;a.push(b)}}};function u(b){var a=m[this.chrno];b.drawImage(e,a.x,a.y,a.w,a.h,this.x,this.y,a.w,a.h)}this.putchr8c=function(e,g,h,f,c){if(!Boolean(c))c=1;for(i=0;i<e.length;i++){var d=e.charCodeAt(i);if(d>=32&&d<128){var b={};b.chrno=d-32;b.x=g+i*(8*c);b.y=h;b.c=f;b.z=c;b.draw=s;a.push(b)}}};function s(b){var a=o[this.c][this.chrno];b.drawImage(e,a.x,a.y,a.w,a.h,this.x+-a.w/2*this.z,this.y+-a.h/2*this.z,a.w*this.z,a.h*this.z)}this.putImage=function(c,d,e){var b={};b.g=c;b.x=d;b.y=e;b.draw=t;a.push(b)};function t(a){a.drawImage(this.g,this.x,this.y)}this.putImage2=function(c,f,g,e,d){var b={};b.g=c;b.x=f;b.y=g;b.w=e;b.h=d;b.draw=r;a.push(b)};function r(a){a.drawImage(this.g,this.x,this.y,this.w,this.h)}this.putImageTransform=function(g,h,i,c,d,e,f){var b={};b.g=g;b.x=h;b.y=i;b.m11=c;b.m12=d;b.m21=e;b.m22=f;b.draw=q;a.push(b)};function q(a){a.save();a.setTransform(this.m11,this.m12,this.m21,this.m22,this.x,this.y);a.drawImage(this.g,0,0);a.restore()}this.transform=function(a,b,d,e){c.setTransform(a,b,d,e,0,0)};this.putFunc=function(b){a.push(b)};this.clear=function(a){c.save();c.setTransform(1,0,0,1,0,0);c.clearRect(0,0,d.width,d.height);c.restore();if(Boolean(a)){c.fillStyle=a;c.fillRect(0,0,d.width,d.height)}};this.reset=function(){a=[]};this.draw=function(){for(var b in a)a[b].draw(c)}}function spdata(){var d=[["Ship",0,0,31,31],["Ship_r",32,0,31,31],["Enemy1",64,0,31,31],["Enemy2",96,0,31,31],["Enemy3",128,0,31,31],["S_Tama",0,32,7,7],["MoTama",16,32,15,15],["MbTama",32,32,15,15],["YaTama",48,32,15,15],["Zanki",64,32,15,15],["Bomb1",160,0,31,31],["Bomb2",192,0,31,31],["Bomb3",224,0,31,31],["Bomb4",256,0,31,31],["Bomb5",288,0,31,31],["Powup1",128,32,31,15],["Powup2",160,32,31,15],["Powup3",192,32,31,15],["Powup4",224,32,31,15],["Boss",0,64,31,31],["MiniB",32,64,16,16],["Wave",64,64,159,31],["Missile",80,32,15,15],["Laser",48,64,15,31],["Laser2",80,48,15,15],["Option",96,32,15,15],["Option1",96,32,15,15],["Option2",64,144,15,15],["Option3",64,160,15,15],["Gunpod",80,144,15,31],["Boardw",0,96,223,31],["Boardh",288,32,31,95],["pBall",64,48,15,15],["Bonus",112,32,15,15],["Bonus_b",112,32,15,15],["Bonus_r",0,160,15,15],["Bonus_g",16,160,15,15],["Coin1",0,144,15,15],["Coin2",16,144,15,15],["Coin3",32,144,15,15],["Coin4",48,144,15,15],["Kobold",96,48,15,15],["Warn",32,160,15,15],["Mayura1",0,0,32,32],["Mayura2",32,0,32,32],["Mayura3",64,0,32,32],["Mayura4",96,0,32,32],["Unyuu1",128,0,32,32],["Unyuu2",160,0,32,32],["Unyuu3",192,0,32,32],["Fire1",0,32,32,32],["Fire2",32,32,32,32],["Down1",0,64,32,32],["Down2",32,64,32,32],["Down3",64,64,32,32],["Down4",96,64,32,32],["Down5",128,64,32,32],["Zap1",0,96,32,32],["Zap2",32,96,32,32],["Zap3",64,96,32,32],["Zap4",96,96,32,32],["Ball1",128,48,16,16],["Ball2",144,48,16,16],["Ball3",160,48,16,16],["Dummy",112,32,15,15]],c=[];for(var e in d){var b=d[e],a={};a.x=b[1];a.y=b[2];a.w=b[3];a.h=b[4];c[b[0]]=a}return c}function Stage1_tod(){var a;a=new Dangeon_tod;a.create();var g=a.map;this.scenario=f;this.bgImage=d;this.bgLayout=c;this.initial=e;this.bgPtn=b;function f(){for(var e=[],h=0;h<a.mw-1;h+=2)for(var g=0;g<a.mh-1;g+=2)e.push([7e3,h*80+32,g*80+32,180,"common_vset0",4]);e.push([6e5,-1,-1,0,0,0]);var d=[];for(var g in e){var c=e[g],b={};b.count=c[0];b.x=c[1];b.y=c[2];b.r=c[3];b.sc=c[4];b.ch=c[5];d.push(b)}for(var i in d){var f=d[i];f.x=Math.floor(f.x/80)*80+32;f.y=Math.floor(f.y/80)*80+32}return d}function d(){var a=new Image;a.src="pict/cha.png";return a}function c(){for(var d=[],m=a.map,b=[],i=64,h=0,g=0,f=0;f<a.mw-1;f++){g=0;for(var k=f%2==1?16:i,e=0;e<a.mh-1;e++){var j=e%2==1?16:i;if(e%2==0&&f%2==0){b=[0,h,g,i+16,i+16,false,1,true];d.push(b)}if(e%2==1&&f%2==1){b=[12,h,g,k,j,true,1,true];d.push(b)}else if(m[f][e]!="  "){b=[9,h,g,k,j,true,0,true];d.push(b)}g+=j}h+=k}b=[5,Math.floor(Math.random()*((a.mw-1)/2))*80,Math.floor(Math.random()*((a.mw-1)/2))*80,64,64,true,2,true];d.push(b);var b=[11,0,0,80*10+80,4,true,1,true];d.push(b);var b=[11,0,80*10+60,80*10+80,36,true,1,true];d.push(b);var b=[11,0,0,4,80*10+60,true,1,true];d.push(b);var b=[11,80*10+60,0,4,80*10+60,true,1,true];d.push(b);var l=[];for(var e in d){var b=d[e],c={};c.no=b[0];c.x=b[1];c.y=b[2];c.w=b[3];c.h=b[4];c.c=b[5];c.type=b[6];c.view=false;c.visible=b[7];l.push(c)}return l}function e(m){for(var e=[],d=[],k=0,b=0;b<a.mw-1;b++)for(var l=0;l<a.mh-1;l++)if(l%2==0&&b%2==0){d[k]=k;e[k]={};e[k].x=b;e[k].y=l;k++}for(b=0;b<1e3;b++){var p=Math.floor(Math.random()*d.length),o=Math.floor(Math.random()*d.length),c=d[p];d[p]=d[o];d[o]=c}var j=[];j.push([false,e[d[0]].x*40+32,e[d[0]].y*40+32,0,"player",0]);var s=3+Math.floor(m/3),r=Math.floor(m/5),q=Math.floor(m/7),g=1,f=g+s;for(b=g;b<f;b++){var h=d[b];c=[true,e[h].x*40+32,e[h].y*40+32,Math.floor(Math.random()*4)*90,"ememy_move_std",1];j.push(c)}g=f;f+=r;for(b=g;b<f;b++){var h=d[b];c=[true,e[h].x*40+32,e[h].y*40+32,Math.floor(Math.random()*4)*90,"ememy_moveshot_1",1];j.push(c)}g=f;f+=q;for(b=g;b<f;b++){var h=d[b];c=[true,e[h].x*40+32,e[h].y*40+32,Math.floor(Math.random()*4)*90,"sce_ememy_randomshot",1];j.push(c)}g=f;f+=5;for(b=g;b<f;b++){var h=d[b];c=[true,e[h].x*40+32,e[h].y*40+32,Math.floor(Math.random()*360),"common_vset0",20];j.push(c)}var n=[];for(var l in j){var c=j[l],i={};i.s=c[0];i.x=c[1];i.y=c[2];i.r=c[3];i.sc=c[4];i.ch=c[5];n.push(i)}return n}function b(){var d=[[0,0,128,80,80],[5,192,0,32,32],[9,0,208,16,16],[10,0,208,64,16],[11,80,128,16,64],[12,80,208,16,16]],c=[];for(var e in d){var b=d[e],a={};a.x=b[1];a.y=b[2];a.w=b[3];a.h=b[4];c[b[0]]=a}return c}}function TextScreen(){for(var d=30,b=[],c=0;c<d;c++){var a=document.createElement("div");a.id="div"+c;a.style.position="absolute";a.style.display="inline";a.style.top=c+"px";a.style.left=c+"px";a.style.width="24px";a.style.height="20px";var f=document.getElementsByTagName("body").item(0);f.appendChild(a)}var i=0;this.print=function(d,f,g,c){if(!Boolean(c))c="green";var a={};a.text=d;a.x=f;a.y=g;a.color=c;a.draw=e;b.push(a)};function e(a){a.style.color=this.color;a.style.backgroundColor="transparent";a.style.left=this.x+"px";a.style.top=this.y+"px";a.style.width=16*this.text.length+"px";a.style.visibility="visible";a.style.display="inline";a.innerHTML=this.text}this.putFunc=function(a){b.push(a)};this.clear=function(){for(var a=0;a<d;a++){var b=document.getElementById("div"+a);b.style.visibility="hidden";b.style.display="none"}};this.reset=function(){b=[]};this.draw=function(){for(var a in b){if(a>=d)break;b[a].draw(document.getElementById("div"+a))}}}